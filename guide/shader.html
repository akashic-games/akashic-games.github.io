<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-162208211-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-162208211-1');
</script>

<meta charset="UTF-8">
<meta name="viewport"    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="description" content="Akashic EngineはJavaScriptで動作する、無償利用が可能なマルチプラットフォーム対応ゲーム開発エンジンです">
<meta name="theme-color" content="#0F1F26">
<title>シェーダの利用</title>
<link rel="icon"       href="/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="stylesheet" href="/css/common.css?5ddd7a0">
<link rel="stylesheet" href="/css/header.css?5ddd7a0">
<link rel="stylesheet" href="/css/footer.css?5ddd7a0">


<link rel="stylesheet" href="/css/asset.css?5ddd7a0">

<link rel="stylesheet" href="/css/akashic-document.css?5ddd7a0">

<link rel="stylesheet" href="/css/railscasts.css?5ddd7a0">


<script src="/lib/jquery-3.2.1.min.js"></script>
<script src="/lib/common.js?5ddd7a0"></script>


<script src="/lib/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>

<div class="head--spacer"></div>
<div class="SP--head--menu--show"></div>
<div class="SP--head--menu--hide"></div>

<div class="head--menu--outer">
	<ul class="head--menu">
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/tutorial/v3/">Akashic Engine入門</a></li>
				<li><a href="/shin-ichiba/">ニコ生ゲームを作ろう</a></li>
				<!--li><a href="/tutorial/akashic-info.html">Akashic Engine関連情報一覧</a></li-->
			</ul>
		</li>
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/guide/akashic-cli.html">akashic-cli利用ガイド</a></li>
				<li><a href="/guide/game-json.html">game.jsonの仕様</a></li>
				<li><a href="/guide/asset-recommended-spec.html">素材の推奨仕様</a></li>
				<li><a href="/guide/composite-operation.html">CompositeOperationの利用</a></li>
				<li><a href="/guide/storage.html">ストレージについて</a></li>
				<li><a href="/guide/asset-load-error.html">アセットロードエラーについて</a></li>
				<li><a href="/guide/atsumaru.html">RPGアツマール投稿ガイド</a></li>
				<li><a href="/guide/template-guide.html">akashic initテンプレート利用ガイド</a></li>
				<li><a href="/guide/shader.html">シェーダの利用</a></li>
				<li><a href="/guide/shin-ichiba/index.html">ニコニコ生放送で遊べるゲームの作成</a></li>
				<li><a href="/guide/sandbox-config.html">sandbox.config.jsの仕様</a></li>
				<li><a href="/guide/bmpfont-generator.html">bmpfont-generator の仕様</a></li>
				<li><a href="/guide/common-pitfalls.html">よくある落とし穴</a></li>
			</ul>
		</li>
		<li class="head--menu--item"><a class="head--logo" href="/" title="ホーム"></a></li>
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/reference/akashic-engine-v3/globals.html">akashic-engine v3.x</a></li>
				<li><a href="/reference/akashic-timeline/">akashic-timeline</a></li>
				<li><a href="/reference/akashic-animation/">akashic-animation</a></li>
				<li><a href="/reference/akashic-label/">akashic-label</a></li>
				<li><a href="/reference/akashic-tile/">akashic-tile</a></li>
				<li><a href="/reference/akashic-box2d/">akashic-box2d</a></li>
				<li><a href="/reference/coe/">coe framework</a></li>
				<li><a href="/reference/raycaster-js/">raycaster-js</a></li>
				<li><a href="/reference/collision-js/">collision-js</a></li>
				<li><a href="/reference/akashic-engine-v2/modules/_lib_main_d_.g.html">akashic-engine v2.x (旧版)</a></li>
				<li><a href="/reference/akashic-engine-v1/modules/_lib_main_d_.g.html">akashic-engine v1.x (旧版)</a></li>
			</ul>
		</li>
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/demo/?title=helloworld">Hello World</a></li>
				<li><a href="/demo/?title=scale-rotate-opacity">拡縮・回転・透明度</a></li>
				<li><a href="/demo/?title=bitmap-font">ビットマップフォント</a></li>
				<li><a href="/demo/?title=framesprite">フレームアニメーション</a></li>
				<li><a href="/demo/?title=demo-touchevent">タッチイベント</a></li>
				<li><a href="/demo/?title=demo-tile">タイル</a></li>
				<li><a href="/demo/?title=label-sample">ラベル</a></li>
				<li><a href="/demo/?title=animation-showcase">アニメーション制御</a></li>
				<li><a href="/demo/?title=timeline-sample">トゥイーン制御</a></li>
				<li><a href="/demo/?title=simpleShot">アブストラクトシューティング</a></li>
				<li><a href="/demo/?title=HoppingWitch">HOPPING WITCH</a></li>
				<li><a href="/demo/?title=GalaxyWars">GALAXY WARS</a></li>
				<li><a href="/demo/?title=cannontv">いくぜ！ 超会議</a></li>
				<li><a href="/asset/material.html">サンプルデモの素材</a></li>
			</ul>
		</li>
	</ul>
</div>

<header id="akashic-page-header">
	<div class="SP--head--logo--box"><a class="head--logo" href="/" title="ホーム"></a></div>
</header>

<div id="BodyInner">
	<section class="akashic--document safearea--LR">
		<div class="inner responsive--width">
			<h1>シェーダの利用</h1>
<h2><a name="これは"></a> これは</h2>
<p>シェーダプログラムの利用方法を記述したドキュメントです。</p>
<h2><a name="対象バージョン"></a> 対象バージョン</h2>
<p>本ドキュメントの対象バージョンは <code>akashic-engine@2.3.2</code> 以降です。</p>
<p>また、本機能を利用するには WebGL 1.0 が利用可能な環境が必要です。
<a href="http://webglreport.com/">こちらのページ</a> で現在利用しているブラウザが WebGL をサポートしているか確認することができます。</p>
<h2><a name="シェーダとは"></a> シェーダとは</h2>
<p>WebGL, OpenGL などで、3 次元空間に存在する情報を 2 次元空間に描画するために用いられているプログラムのことを指します。詳細については他のドキュメントを参照ください。</p>
<p>本ドキュメントでは Akashic でシェーダを利用する方法について記述します。
<code>akashic-engine@2.3.2</code> ではフラグメントシェーダのみをサポートします。</p>
<h2><a name="準備"></a> 準備</h2>
<p>ゲーム開発の準備が終わっていない場合は <a href="/tutorial/v3/">Akashic を利用したゲーム開発</a> を読んでゲーム開発の環境を整えて下さい。</p>
<p>本ドキュメントの内容は <code>akashic-sandbox@0.13.24</code> 以降のバージョンでサポートされています。手元の akashic-sandbox のバージョンがこれより古い場合は以下のコマンドで最新のものをインストールしてください。</p>
<pre><code class="language-sh">npm i @akashic/akashic-sandbox -g</code></pre>
<p>コンテンツで WebGL を有効にするため、 <code>game.json</code> の <code>renderers</code> に <code>webgl</code> を追加します。詳細は <a href="game-json.html">game.json の仕様</a> を参照してください。</p>
<h2><a name="利用"></a> 利用</h2>
<p>まずはゲーム内でシェーダを利用するための準備をします。</p>
<p>以下は出力色をモノクロ化するフラグメントシェーダの記述になります。</p>
<pre><code class="language-glsl">#version 100
precision mediump float;

varying vec2 vTexCoord;
uniform sampler2D uSampler;
uniform float uAlpha;

void main(void)
{
  // 対象ピクセルの色情報を取得
  vec4 color = texture2D(uSampler, vTexCoord);

  // 対象ピクセルのRGB値を加算
  float sum = dot(color.rgb, vec3(1.0));

  // モノクロ化
  vec3 outColor = vec3(sum / 3.0);

  // 最終出力色
  gl_FragColor = vec4(outColor, color.a * uAlpha);
}</code></pre>
<p>このシェーダをコンテンツ内で利用するために、 <code>g.ShaderProgram</code> を生成します。
(注意: この生成方法は <code>akashic-engine@2.3.2</code> 時点での記述になります。今後のバージョンでは変更される可能性があります。)</p>
<pre><code class="language-javascript">// フラグメントシェーダのテキストデータ
const fragmentShader =
  &quot;#version 100\n&quot; +
  &quot;precision mediump float;\n&quot; +
  &quot;varying vec2 vTexCoord;\n&quot; +
  &quot;uniform sampler2D uSampler;\n&quot; +
  &quot;uniform float uAlpha;\n&quot; +
  &quot;void main(void)\n&quot; +
  &quot;{\n&quot; +
  &quot;  vec4 color = texture2D(uSampler, vTexCoord);\n&quot; +
  &quot;  float sum = dot(color.rgb, vec3(1.0));\n&quot; +
  &quot;  vec3 outColor = vec3(sum / 3.0);\n&quot; +
  &quot;  gl_FragColor = vec4(outColor, color.a * uAlpha);\n&quot; +
  &quot;}&quot;;

const shader = new g.ShaderProgram({
  fragmentShader: fragmentShader
});</code></pre>
<p><code>g.ShaderProgram</code> は <code>g.E</code> やそれを継承したクラス (<code>g.Sprite</code> , <code>g.Pane</code> など) に適用できます。以下のようにコンストラクタのパラメータに指定することができます。</p>
<pre><code class="language-javascript">var sprite = new g.Sprite({
  scene: scene,
  src: scene.assets[&quot;sample&quot;],
  width: 100,
  height: 100,
  shaderProgram: shader
});</code></pre>
<p>既存の <code>g.Sprite</code> に適用することもできます。その場合は変更後に <code>g.Sprite#modified()</code> を呼ぶ必要があります。</p>
<pre><code class="language-javascript">sprite.shaderProgram = shader;
sprite.modified();</code></pre>
<p>シェーダプログラムは親エンティティの値を継承します。そのため、シェーダプログラムを適用したエンティティに複数の子エンティティに追加することで、複数のエンティティに同一のシェーダプログラムを適用することができます。</p>
<p>設定したシェーダを戻したい場合、 <code>undefined</code> または <code>null</code> を指定します。
<code>undefined</code> と <code>null</code> は以下のように挙動が異なることにご留意ください。</p>
<ul>
<li><code>undefined</code><ul>
<li>親エンティティのシェーダプログラムを利用する。(デフォルト)</li>
</ul>
</li>
<li><code>null</code><ul>
<li>親エンティティのシェーダプログラムを利用せず、常に初期のシェーダプログラム( <code>undefined</code> )を利用する。</li>
</ul>
</li>
</ul>
<p>注意点として、 <code>g.ShaderProgram</code> は一度生成したら以降プロパティを変更することはできません。
(例外的に <code>g.ShaderProgram#uniforms#value</code> のみ変更が許可されています。詳細は後述します。)</p>
<h2><a name="変数"></a> 変数</h2>
<p><code>akashic-engine@2.3.2</code> 時点では、以下の変数がエンジン側から暗黙的に与えられます。</p>
<ul>
<li><code>varying</code><ul>
<li><code>vec2 vTexCoord</code><ul>
<li>対象の描画元のテクスチャ座標</li>
<li>本値は 0 ～ 1.0 の範囲内で任意の矩形領域となり得ることに注意。</li>
</ul>
</li>
</ul>
</li>
<li><code>uniform</code><ul>
<li><code>sampler2D uSampler</code><ul>
<li>対象の描画元のテクスチャ番号</li>
</ul>
</li>
<li><code>float uAlpha</code><ul>
<li>透過度 (0 ～ 1.0 の範囲内)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a name="ユーザ定義変数"></a> ユーザ定義変数</h2>
<p>ユーザが独自に定義した変数をフラグメントシェーダに与えることができます。</p>
<p>先程のサンプルにおいて、各色の重み付けをコンテンツから指定した例が以下になります。</p>
<pre><code class="language-glsl">#version 100
precision mediump float;

varying vec2 vTexCoord;
uniform sampler2D uSampler;
uniform float uAlpha;

uniform float redScale;
uniform float greenScale;
uniform float blueScale;

vec3 monoScale = vec3(redScale, greenScale, blueScale);
float monoScaleSum = dot(monoScale, vec3(1.0));

void main(void)
{
  // 対象ピクセルの色情報を取得
  vec4 color = texture2D(uSampler, vTexCoord);

  // 対象ピクセルのRGB値を加算
  float sum = dot(color.rgb, monoScale);

  // モノクロ化
  vec3 outColor = vec3(sum / monoScaleSum);

  // 最終出力色
  gl_FragColor = vec4(outColor, color.a * uAlpha);
}</code></pre>
<p><code>redScale</code> , <code>greenScale</code> , <code>blueScale</code> が uniform 値として渡されるようにフラグメントシェーダを修正しています。</p>
<p><code>g.ShaderProgram</code> の生成時に利用する uniform を定義します。</p>
<pre><code class="language-javascript">const shader = new g.ShaderProgram({
  fragmentShader: fragmentShader,
  uniforms: {
    redScale: {
      type: &quot;float&quot;,
      value: 0.299
    },
    greenScale: {
      type: &quot;float&quot;,
      value: 0.587
    },
    blueScale: {
      type: &quot;float&quot;,
      value: 0.114
    }
  }
});</code></pre>
<p><code>uniform</code> は、フラグメントシェーダで利用する際の変数名をキーとしたオブジェクトによって定義されます。各キーは <code>g.ShaderUniform</code> によって定義された形式で記述する必要があります。
<code>type</code> は対象の uniform の型、<code>value</code>はその値を示します。</p>
<p><code>type</code> には以下が指定できます。</p>
<ul>
<li><code>float</code></li>
<li><code>int</code></li>
<li><code>vec2</code></li>
<li><code>vec3</code></li>
<li><code>vec4</code></li>
<li><code>ivec2</code></li>
<li><code>ivec3</code></li>
<li><code>ivec4</code></li>
<li><code>mat2</code></li>
<li><code>mat3</code></li>
<li><code>mat4</code></li>
</ul>
<p>また、以下のように Array を利用することもできます。</p>
<p><strong>フラグメントシェーダ</strong></p>
<pre><code class="language-glsl">uniform param[3];</code></pre>
<p><strong>コンテンツ</strong></p>
<pre><code class="language-javascript">const shader = new g.ShaderProgram({
  fragmentShader: fragmentShader,
  uniforms: {
    param: {
      type: &quot;float&quot;,
      value: [0.0, 1.0, 0.4]
    }
  }
});</code></pre>
<p><code>g.ShaderProgram#uniform#value</code> の値はプログラムの実行中に任意に変更できます。</p>
<pre><code class="language-javascript">scene.update.add(() =&gt; {
  shader.uniforms.time.value = scene.game.age;
});</code></pre>

		</div>
	</section>
	<footer class="safearea--LR">
	<div class="responsive--width">

		<ul class="foot--creativecommons">
			<li class="foot--creativecommons--ban"><a href="http://creativecommons.org/licenses/by/2.1/jp/" target="_blank"><img alt="クリエイティブ・コモンズ・ライセンス" src="https://i.creativecommons.org/l/by/2.1/jp/80x15.png"></a></li>
			<li class="foot--creativecommons--txt">このサイトの画像は、一部を除き <a rel="license" href="http://creativecommons.org/licenses/by/2.1/jp/" target="_blank">クリエイティブ・コモンズ 表示 2.1 日本 ライセンス</a><br>の下に提供されています: <a href="/image-license.html">詳細</a></li>
		</ul>

		<ul class="foot--license">
			<li class="foot--license--akashic"><a href="https://akashic-games.github.io"></a></li>
			<li class="foot--license--dwango"><a href="http://dwango.co.jp" target="_blank">&copy; dwango</a></li>
		</ul>

	</div>
</footer>

</div>
<div class="page--top"></div>
<div class="window--dark"></div>

<script>
	// リサイズ時にコンテンツのリサイズができない状態なので暫定対応でコンテンツをリロードしている
	// TODO: リサイズ時にコンテンツも追従する仕組みを作成する
	window.addEventListener('resize', function() {
		var iframes = document.getElementsByClassName('akashic-content');
		var contents = Array.prototype.slice.call(iframes);
		contents.forEach(function(content) {
			content.contentWindow.location.reload(true);
		});
	});
</script>
</body>
</html>
