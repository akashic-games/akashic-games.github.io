!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).g=e()}(this,(function(){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function i(t,e){return t(e={exports:{}},e.exports),e.exports}var r=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){this._handlers=[],this.length=0}return t.prototype.add=function(t,e){if("function"==typeof t)this._handlers.push({func:t,owner:e,once:!1,name:void 0});else{var i=t;"number"==typeof i.index?this._handlers.splice(i.index,0,{func:i.func,owner:i.owner,once:!1,name:i.name}):this._handlers.push({func:i.func,owner:i.owner,once:!1,name:i.name})}this.length=this._handlers.length},t.prototype.addOnce=function(t,e){if("function"==typeof t)this._handlers.push({func:t,owner:e,once:!0,name:void 0});else{var i=t;"number"==typeof i.index?this._handlers.splice(i.index,0,{func:i.func,owner:i.owner,once:!0,name:i.name}):this._handlers.push({func:i.func,owner:i.owner,once:!0,name:i.name})}this.length=this._handlers.length},t.prototype.handle=function(t,e,i){this.add(e?{owner:t,func:e,name:i}:{func:t})},t.prototype.fire=function(t){if(this._handlers&&this._handlers.length){for(var e=this._handlers.concat(),i=0;i<e.length;i++){var r=e[i];if(r.func.call(r.owner,t)||r.once){var o=this._handlers.indexOf(r);-1!==o&&this._handlers.splice(o,1)}}null!=this._handlers&&(this.length=this._handlers.length)}},t.prototype.contains=function(t,e){for(var i="function"==typeof t?{func:t,owner:e}:t,r=0;r<this._handlers.length;r++)if(this._comparePartial(i,this._handlers[r]))return!0;return!1},t.prototype.remove=function(t,e){for(var i="function"==typeof t?{func:t,owner:e}:t,r=0;r<this._handlers.length;r++){var o=this._handlers[r];if(i.func===o.func&&i.owner===o.owner&&i.name===o.name)return this._handlers.splice(r,1),void--this.length}},t.prototype.removeAll=function(t){var e=[];if(t)for(var i=0;i<this._handlers.length;i++){var r=this._handlers[i];this._comparePartial(t,r)||e.push(r)}this._handlers=e,this.length=this._handlers.length},t.prototype.destroy=function(){this._handlers=null,this.length=null},t.prototype.destroyed=function(){return null===this._handlers},t.prototype._comparePartial=function(t,e){return(void 0===t.func||t.func===e.func)&&((void 0===t.owner||t.owner===e.owner)&&(void 0===t.name||t.name===e.name))},t}();e.Trigger=i}));e(r);r.Trigger;var o=i((function(e,i){var o,n=t&&t.__extends||(o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0});var s=function(t){function e(e,i,r){var o=t.call(this)||this;return o.chain=e,o.filter=null!=i?i:null,o.filterOwner=r,o._isActivated=!1,o}return n(e,t),e.prototype.add=function(e,i){t.prototype.add.call(this,e,i),this._isActivated||(this.chain.add(this._onChainTriggerFired,this),this._isActivated=!0)},e.prototype.addOnce=function(e,i){t.prototype.addOnce.call(this,e,i),this._isActivated||(this.chain.add(this._onChainTriggerFired,this),this._isActivated=!0)},e.prototype.remove=function(e,i){t.prototype.remove.call(this,e,i),0===this.length&&this._isActivated&&(this.chain.remove(this._onChainTriggerFired,this),this._isActivated=!1)},e.prototype.removeAll=function(e){t.prototype.removeAll.call(this,e),0===this.length&&this._isActivated&&(this.chain.remove(this._onChainTriggerFired,this),this._isActivated=!1)},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.chain.remove(this._onChainTriggerFired,this),this.filter=null,this.filterOwner=null,this._isActivated=!1},e.prototype._onChainTriggerFired=function(t){this.filter&&!this.filter.call(this.filterOwner,t)||this.fire(t)},e}(r.Trigger);i.ChainTrigger=s}));e(o);o.ChainTrigger;var n=i((function(t,e){function i(t){for(var i in t)e.hasOwnProperty(i)||(e[i]=t[i])}Object.defineProperty(e,"__esModule",{value:!0}),i(r),i(o)}));e(n);var s=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(s);var a=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(a);var h=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.CompositeOperation=void 0,function(t){t[t.SourceOver=0]="SourceOver",t[t.SourceAtop=1]="SourceAtop",t[t.Lighter=2]="Lighter",t[t.Copy=3]="Copy",t[t.ExperimentalSourceIn=4]="ExperimentalSourceIn",t[t.ExperimentalSourceOut=5]="ExperimentalSourceOut",t[t.ExperimentalDestinationAtop=6]="ExperimentalDestinationAtop",t[t.ExperimentalDestinationIn=7]="ExperimentalDestinationIn",t[t.DestinationOut=8]="DestinationOut",t[t.DestinationOver=9]="DestinationOver",t[t.Xor=10]="Xor"}(e.CompositeOperation||(e.CompositeOperation={}))}));e(h);h.CompositeOperation;var c=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(c);var l=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(l);var d=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(d);var u=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(u);var p=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(p);var f=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(f);var _=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(_);var y=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(y);var g=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(g);var v=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(v);var m=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(m);var S=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(S);var A=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(A);var x=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(x);var P=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(P);var b=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(b);var w=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(w);var M=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(M);var O=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(O);var E=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(E);var T=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AssetLoadErrorType=void 0,function(t){t[t.Unspecified=0]="Unspecified",t[t.RetryLimitExceeded=1]="RetryLimitExceeded",t[t.NetworkError=2]="NetworkError",t[t.ClientError=3]="ClientError",t[t.ServerError=4]="ServerError"}(e.AssetLoadErrorType||(e.AssetLoadErrorType={}))}));e(T);T.AssetLoadErrorType;var C=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(C);var L=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.FontWeight=void 0,function(t){t[t.Normal=0]="Normal",t[t.Bold=1]="Bold"}(e.FontWeight||(e.FontWeight={}))}));e(L);L.FontWeight;var F=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.FontFamily=void 0,function(t){t[t.SansSerif=0]="SansSerif",t[t.Serif=1]="Serif",t[t.Monospace=2]="Monospace"}(e.FontFamily||(e.FontFamily={}))}));e(F);F.FontFamily;var j=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(j);var I=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(I);var k=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(k);var R=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(R);var U=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(U);var D=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(D);var z=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(z);var B=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(B);var G=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(G);var W=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(W);var N=i((function(e,i){var r=t&&t.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),o=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||e.hasOwnProperty(i)||r(e,t,i)};Object.defineProperty(i,"__esModule",{value:!0}),o(s,i),o(a,i),o(h,i),o(c,i),o(l,i),o(d,i),o(u,i),o(p,i),o(f,i),o(_,i),o(y,i),o(g,i),o(v,i),o(m,i),o(S,i),o(A,i),o(x,i),o(P,i),o(b,i),o(w,i),o(M,i),o(O,i),o(E,i),o(T,i),o(C,i),o(L,i),o(F,i),o(j,i),o(I,i),o(k,i),o(R,i),o(U,i),o(D,i),o(z,i),o(B,i),o(G,i),o(W,i)}));e(N);var X=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ExceptionFactory=void 0,function(t){t.createAssertionError=function(t,e){var i=new Error(t);return i.name="AssertionError",i.cause=e,i},t.createTypeMismatchError=function(t,e,i,r){var o="Type mismatch on "+t+", expected type is "+e;if(arguments.length>2)try{var n;o+=", actual type is "+((n=i&&i.constructor&&i.constructor.name?i.constructor.name:typeof i).length>40?n.substr(0,40):n)}catch(t){}o+=".";var s=new Error(o);return s.name="TypeMismatchError",s.cause=r,s.expected=e,s.actual=i,s},t.createAssetLoadError=function(t,e,i,r){void 0===e&&(e=!0);var o=new Error(t);return o.name="AssetLoadError",o.cause=r,o.retriable=e,o}}(e.ExceptionFactory||(e.ExceptionFactory={}))}));e(X);X.ExceptionFactory;var q=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.SoundAudioSystem=i.MusicAudioSystem=i.AudioSystem=void 0;var n=function(){function t(t){this.id=t.id,this._volume=t.volume||1,this._destroyRequestedAssets={},this._explicitMuted=t.muted||!1,this._suppressed=!1,this._muted=!1,this._resourceFactory=t.resourceFactory,this._updateMuted()}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){if(t<0||t>1||isNaN(t)||"number"!=typeof t)throw X.ExceptionFactory.createAssertionError("AudioSystem#volume: expected: 0.0-1.0, actual: "+t);this._volume=t,this._onVolumeChanged()},enumerable:!1,configurable:!0}),t.prototype.requestDestroy=function(t){this._destroyRequestedAssets[t.id]=t},t.prototype._reset=function(){this.stopAll(),this._volume=1,this._destroyRequestedAssets={},this._muted=!1,this._suppressed=!1,this._explicitMuted=!1},t.prototype._setMuted=function(t){var e=this._explicitMuted;this._explicitMuted=!!t,this._explicitMuted!==e&&(this._updateMuted(),this._onMutedChanged())},t.prototype._setPlaybackRate=function(t){if(t<0||isNaN(t)||"number"!=typeof t)throw X.ExceptionFactory.createAssertionError("AudioSystem#playbackRate: expected: greater or equal to 0.0, actual: "+t);this._suppressed=1!==t,this._updateMuted()},t.prototype._updateMuted=function(){this._muted=this._explicitMuted||this._suppressed},t}();i.AudioSystem=n;var s=function(t){function e(e){var i=t.call(this,e)||this;return i._player=void 0,i}return o(e,t),Object.defineProperty(e.prototype,"player",{get:function(){return this._player||(this._player=this._resourceFactory.createAudioPlayer(this),this._player.onPlay.add(this._handlePlay,this),this._player.onStop.add(this._handleStop,this)),this._player},set:function(t){this._player=t},enumerable:!1,configurable:!0}),e.prototype.findPlayers=function(t){return this.player.currentAudio&&this.player.currentAudio.id===t.id?[this.player]:[]},e.prototype.createPlayer=function(){return this.player},e.prototype.stopAll=function(){this._player&&this._player.stop()},e.prototype._reset=function(){t.prototype._reset.call(this),this._player&&(this._player.onPlay.remove(this._handlePlay,this),this._player.onStop.remove(this._handleStop,this)),this._player=void 0},e.prototype._onVolumeChanged=function(){this.player._notifyVolumeChanged()},e.prototype._onMutedChanged=function(){this.player._changeMuted(this._muted)},e.prototype._setPlaybackRate=function(e){t.prototype._setPlaybackRate.call(this,e),this.player._changeMuted(this._muted)},e.prototype._handlePlay=function(t){if(t.player!==this._player)throw X.ExceptionFactory.createAssertionError("MusicAudioSystem#_onPlayerPlayed: unexpected audio player")},e.prototype._handleStop=function(t){this._destroyRequestedAssets[t.audio.id]&&(delete this._destroyRequestedAssets[t.audio.id],t.audio.destroy())},e}(n);i.MusicAudioSystem=s;var a=function(t){function e(e){var i=t.call(this,e)||this;return i.players=[],i}return o(e,t),e.prototype.createPlayer=function(){var t=this._resourceFactory.createAudioPlayer(this);return t.canHandleStopped()&&this.players.push(t),t.onPlay.add(this._handlePlay,this),t.onStop.add(this._handleStop,this),t},e.prototype.findPlayers=function(t){for(var e=[],i=0;i<this.players.length;++i){var r=this.players[i].currentAudio;r&&r.id===t.id&&e.push(this.players[i])}return e},e.prototype.stopAll=function(){for(var t=this.players.concat(),e=0;e<t.length;++e)t[e].stop()},e.prototype._reset=function(){t.prototype._reset.call(this);for(var e=0;e<this.players.length;++e){var i=this.players[e];i.onPlay.remove(this._handlePlay,this),i.onStop.remove(this._handleStop,this)}this.players=[]},e.prototype._onMutedChanged=function(){for(var t=this.players,e=0;e<t.length;++e)t[e]._changeMuted(this._muted)},e.prototype._setPlaybackRate=function(e){t.prototype._setPlaybackRate.call(this,e);var i=this.players;if(this._suppressed)for(var r=0;r<i.length;++r)i[r]._changeMuted(!0)},e.prototype._handlePlay=function(t){},e.prototype._handleStop=function(t){var e=this.players.indexOf(t.player);e<0||(t.player.onStop.remove(this._handleStop,this),this.players.splice(e,1),this._destroyRequestedAssets[t.audio.id]&&(delete this._destroyRequestedAssets[t.audio.id],t.audio.destroy()))},e.prototype._onVolumeChanged=function(){for(var t=0;t<this.players.length;++t)this.players[t]._notifyVolumeChanged()},e}(n);i.SoundAudioSystem=a}));e(q);q.SoundAudioSystem,q.MusicAudioSystem,q.AudioSystem;var H=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.PathUtil=void 0,function(t){t.resolvePath=function(e,i){function r(t){var e=t.split("/");return""===e[e.length-1]&&e.pop(),e}if(""===i)return e;for(var o=t.splitPath(e),n=r(o.path).concat(r(i)),s=[],a=0;a<n.length;++a){var h=n[a];switch(h){case"..":var c=s.pop();if(void 0===c||""===c||"."===c)throw X.ExceptionFactory.createAssertionError("PathUtil.resolvePath: invalid arguments");break;case".":0===s.length&&s.push(".");break;case"":s=[""];break;default:s.push(h)}}return o.host+s.join("/")},t.resolveDirname=function(t){var e=t.lastIndexOf("/");return-1===e?t:t.substr(0,e)},t.resolveExtname=function(t){for(var e=t.length-1;e>=0;--e){var i=t.charAt(e);if("."===i)return t.substr(e);if("/"===i)return""}return""},t.makeNodeModulePaths=function(e){var i=t.splitPath(e),r=i.host;"/"===(e=i.path)[e.length-1]&&(e=e.slice(0,e.length-1));for(var o=e.split("/"),n=o.indexOf("node_modules"),s=n>0?n-1:0,a=[],h=o.length-1;h>=s;--h)if("node_modules"!==o[h]){var c=o.slice(0,h+1);c.push("node_modules");var l=c.join("/");a.push(r+l)}return a},t.splitPath=function(t){var e="",i=t.indexOf("//");if(i>=0){var r=t.indexOf("/",i+2);r>=0?(e=t.slice(0,r),t=t.slice(r)):(e=t,t="/")}else e="";return{host:e,path:t}}}(e.PathUtil||(e.PathUtil={}))}));e(H);H.PathUtil;var V=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Module=void 0;var i=function(t){var e=this,i=t.path,r=H.PathUtil.resolveDirname(i),o=t.virtualPath,n=o?H.PathUtil.resolveDirname(o):void 0,s=t.requireFunc,a=t.resolveFunc;this._runtimeValue=Object.create(t.runtimeValueBase,{filename:{value:i,enumerable:!0},dirname:{value:r,enumerable:!0},module:{value:this,writable:!0,enumerable:!0,configurable:!0}}),this.id=t.id,this.filename=t.path,this.exports={},this.parent=null,this.loaded=!1,this.children=[],this.paths=n?H.PathUtil.makeNodeModulePaths(n):[],this._dirname=r,this._virtualDirname=n;var h=function(t){return s(t,e)};h.resolve=function(t){return a(t,e)},this.require=h};e.Module=i}));e(V);V.Module;var Y=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ShaderProgram=void 0;var i=function(t){this.fragmentShader=t.fragmentShader,this.uniforms=t.uniforms};e.ShaderProgram=i}));e(Y);Y.ShaderProgram;var J=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.VideoSystem=void 0;var i=function(){};e.VideoSystem=i}));e(J);J.VideoSystem;var K=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.SeedEvent=i.PlayerInfoEvent=i.TimestampEvent=i.LeaveEvent=i.JoinEvent=i.OperationEvent=i.MessageEvent=i.PointMoveEventBase=i.PointUpEventBase=i.PointDownEventBase=i.PointEventBase=void 0;var n=function(t,e,i,r,o,n){this.eventFlags=n,this.local=!!o,this.player=r,this.pointerId=t,this.target=e,this.point=i};i.PointEventBase=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="point-down",e}return o(e,t),e}(n);i.PointDownEventBase=s;var a=function(t){function e(e,i,r,o,n,s,a,h){var c=t.call(this,e,i,r,s,a,h)||this;return c.type="point-up",c.prevDelta=o,c.startDelta=n,c}return o(e,t),e}(n);i.PointUpEventBase=a;var h=function(t){function e(e,i,r,o,n,s,a,h){var c=t.call(this,e,i,r,s,a,h)||this;return c.type="point-move",c.prevDelta=o,c.startDelta=n,c}return o(e,t),e}(n);i.PointMoveEventBase=h;var c=function(t,e,i,r){this.type="message",this.eventFlags=r,this.local=!!i,this.player=e,this.data=t};i.MessageEvent=c;var l=function(t,e,i,r,o){this.type="operation",this.eventFlags=o,this.local=!!r,this.player=i,this.code=t,this.data=e};i.OperationEvent=l;var d=function(t,e,i){this.type="join",this.eventFlags=i,this.player=t,this.storageValues=e};i.JoinEvent=d;var u=function(t,e){this.type="leave",this.eventFlags=e,this.player=t};i.LeaveEvent=u;var p=function(t,e,i){this.type="timestamp",this.eventFlags=i,this.player=e,this.timestamp=t};i.TimestampEvent=p;var f=function(t,e){this.type="player-info",this.eventFlags=e,this.player=t};i.PlayerInfoEvent=f;var _=function(t,e){this.type="seed",this.eventFlags=e,this.generator=t};i.SeedEvent=_}));e(K);K.SeedEvent,K.PlayerInfoEvent,K.TimestampEvent,K.LeaveEvent,K.JoinEvent,K.OperationEvent,K.MessageEvent,K.PointMoveEventBase,K.PointUpEventBase,K.PointDownEventBase,K.PointEventBase;var $=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.PlainMatrix=void 0;var i=function(){function t(t,e,i,r,o,n,s){void 0===t?(this._modified=!1,this._matrix=[1,0,0,1,0,0]):"number"==typeof t?(this._modified=!1,this._matrix=new Array(6),this.update(t,e,i,r,o,0,0,n,s)):(this._modified=t._modified,this._matrix=[t._matrix[0],t._matrix[1],t._matrix[2],t._matrix[3],t._matrix[4],t._matrix[5]])}return t.prototype.update=function(t,e,i,r,o,n,s,a,h){if(null!=a&&null!=h){var c=o*Math.PI/180,l=Math.cos(c),d=Math.sin(c),u=l*i,p=d*i,f=d*r,_=l*r,y=a*t,g=h*e;this._matrix[0]=u,this._matrix[1]=p,this._matrix[2]=-f,this._matrix[3]=_,this._matrix[4]=-u*y+f*g+n,this._matrix[5]=-p*y-_*g+s}else this._updateWithoutAnchor(t,e,i,r,o,n,s)},t.prototype._updateWithoutAnchor=function(t,e,i,r,o,n,s){var a=o*Math.PI/180,h=Math.cos(a),c=Math.sin(a),l=h*i,d=c*i,u=c*r,p=h*r,f=t/2,_=e/2;this._matrix[0]=l,this._matrix[1]=d,this._matrix[2]=-u,this._matrix[3]=p,this._matrix[4]=-l*f+u*_+f+n,this._matrix[5]=-d*f-p*_+_+s},t.prototype.updateByInverse=function(t,e,i,r,o,n,s,a,h){if(null!=a&&null!=h){var c=o*Math.PI/180,l=Math.cos(c),d=Math.sin(c),u=l/i,p=d/r,f=d/i,_=l/r,y=a*t,g=h*e;this._matrix[0]=u,this._matrix[1]=-p,this._matrix[2]=f,this._matrix[3]=_,this._matrix[4]=-u*n-f*s+y,this._matrix[5]=p*n-_*s+g}else this._updateByInverseWithoutAnchor(t,e,i,r,o,n,s)},t.prototype._updateByInverseWithoutAnchor=function(t,e,i,r,o,n,s){var a=o*Math.PI/180,h=Math.cos(a),c=Math.sin(a),l=h/i,d=c/r,u=c/i,p=h/r,f=t/2,_=e/2;this._matrix[0]=l,this._matrix[1]=-d,this._matrix[2]=u,this._matrix[3]=p,this._matrix[4]=-l*(f+n)-u*(_+s)+f,this._matrix[5]=d*(f+n)-p*(_+s)+_},t.prototype.multiply=function(t){var e=this._matrix,i=t._matrix,r=e[0],o=e[1],n=e[2],s=e[3];e[0]=r*i[0]+n*i[1],e[1]=o*i[0]+s*i[1],e[2]=r*i[2]+n*i[3],e[3]=o*i[2]+s*i[3],e[4]=r*i[4]+n*i[5]+e[4],e[5]=o*i[4]+s*i[5]+e[5]},t.prototype.multiplyLeft=function(t){var e=t._matrix,i=this._matrix,r=i[0],o=i[2],n=i[4];i[0]=e[0]*r+e[2]*i[1],i[1]=e[1]*r+e[3]*i[1],i[2]=e[0]*o+e[2]*i[3],i[3]=e[1]*o+e[3]*i[3],i[4]=e[0]*n+e[2]*i[5]+e[4],i[5]=e[1]*n+e[3]*i[5]+e[5]},t.prototype.multiplyNew=function(t){var e=this.clone();return e.multiply(t),e},t.prototype.reset=function(t,e){this._matrix[0]=1,this._matrix[1]=0,this._matrix[2]=0,this._matrix[3]=1,this._matrix[4]=t||0,this._matrix[5]=e||0},t.prototype.clone=function(){return new t(this)},t.prototype.multiplyInverseForPoint=function(t){var e=this._matrix,i=1/(e[0]*e[3]+e[2]*-e[1]);return{x:e[3]*i*t.x+-e[2]*i*t.y+(e[5]*e[2]-e[4]*e[3])*i,y:e[0]*i*t.y+-e[1]*i*t.x+(-e[5]*e[0]+e[4]*e[1])*i}},t.prototype.scale=function(t,e){var i=this._matrix;i[0]*=t,i[1]*=e,i[2]*=t,i[3]*=e,i[4]*=t,i[5]*=e},t.prototype.multiplyPoint=function(t){var e=this._matrix;return{x:e[0]*t.x+e[2]*t.y+e[4],y:e[1]*t.x+e[3]*t.y+e[5]}},t}();e.PlainMatrix=i}));e($);$.PlainMatrix;var Z=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Object2D=void 0;var i=function(){function t(t){t?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.opacity=null!=t.opacity?t.opacity:1,this.scaleX=null!=t.scaleX?t.scaleX:1,this.scaleY=null!=t.scaleY?t.scaleY:1,this.angle=t.angle||0,this.compositeOperation=t.compositeOperation,this.anchorX=void 0===t.anchorX?0:t.anchorX,this.anchorY=void 0===t.anchorY?0:t.anchorY,this._matrix=void 0):(this.x=0,this.y=0,this.width=0,this.height=0,this.opacity=1,this.scaleX=1,this.scaleY=1,this.angle=0,this.compositeOperation=void 0,this.anchorX=0,this.anchorY=0,this._matrix=void 0)}return t.prototype.moveTo=function(t,e){if("number"==typeof t&&"number"!=typeof e)throw X.ExceptionFactory.createAssertionError("Object2D#moveTo: arguments must be CommonOffset or pair of x and y as a number.");"number"==typeof t?(this.x=t,this.y=e):(this.x=t.x,this.y=t.y)},t.prototype.moveBy=function(t,e){this.x+=t,this.y+=e},t.prototype.resizeTo=function(t,e){if("number"==typeof t&&"number"!=typeof e)throw X.ExceptionFactory.createAssertionError("Object2D#resizeTo: arguments must be CommonSize or pair of width and height as a number.");"number"==typeof t?(this.width=t,this.height=e):(this.width=t.width,this.height=t.height)},t.prototype.resizeBy=function(t,e){this.width+=t,this.height+=e},t.prototype.scale=function(t){this.scaleX=t,this.scaleY=t},t.prototype.anchor=function(t,e){this.anchorX=t,this.anchorY=e},t.prototype.getMatrix=function(){if(this._matrix){if(!this._matrix._modified)return this._matrix}else this._matrix=new $.PlainMatrix;return this._updateMatrix(),this._matrix._modified=!1,this._matrix},t.prototype._updateMatrix=function(){this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?this._matrix.update(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y,this.anchorX,this.anchorY):this._matrix.reset(this.x,this.y)},t}();e.Object2D=i}));e(Z);Z.Object2D;var Q=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Util=void 0,function(t){var e;t.distance=function(t,e,i,r){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-r,2))},t.distanceBetweenOffsets=function(e,i){return t.distance(e.x,e.y,i.x,i.y)},t.distanceBetweenAreas=function(e,i){return t.distance(e.x+e.width/2,e.y+e.height/2,i.x+i.width/2,i.y+i.height/2)},t.charCodeAt=function(t,e){var i=t.charCodeAt(e);return 55296<=i&&i<=56319?i<<16|t.charCodeAt(e+1):56320<=i&&i<=57343?null:i},t.enumToSnakeCase=function(t,e){var i=t[e];return i[0].toLowerCase()+i.slice(1).replace(/[A-Z]/g,(function(t){return"-"+t.toLowerCase()}))},t.compositeOperationStringTable=((e={})[N.CompositeOperation.SourceOver]="source-over",e[N.CompositeOperation.SourceAtop]="source-atop",e[N.CompositeOperation.Lighter]="lighter",e[N.CompositeOperation.Copy]="copy",e[N.CompositeOperation.ExperimentalSourceIn]="experimental-source-in",e[N.CompositeOperation.ExperimentalSourceOut]="experimental-source-out",e[N.CompositeOperation.ExperimentalDestinationAtop]="experimental-destination-atop",e[N.CompositeOperation.ExperimentalDestinationIn]="experimental-destination-in",e[N.CompositeOperation.DestinationOut]="destination-out",e[N.CompositeOperation.DestinationOver]="destination-over",e[N.CompositeOperation.Xor]="xor",e)}(e.Util||(e.Util={}))}));e(Q);Q.Util;var tt=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.E=i.PointMoveEvent=i.PointUpEvent=i.PointDownEvent=void 0;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(K.PointDownEventBase);i.PointDownEvent=s;var a=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(K.PointUpEventBase);i.PointUpEvent=a;var h=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(K.PointMoveEventBase);i.PointMoveEvent=h;var c=function(t){function e(e){var i=t.call(this,e)||this;if(i.children=void 0,i.parent=void 0,i._touchable=!1,i.state=0,i._hasTouchableChildren=!1,i._onUpdate=void 0,i._onMessage=void 0,i._onPointDown=void 0,i._onPointMove=void 0,i._onPointUp=void 0,i.tag=e.tag,i.shaderProgram=e.shaderProgram,i.local="non-local"!==e.scene.local||!!e.local,e.children)for(var r=0;r<e.children.length;++r)i.append(e.children[r]);return e.parent&&e.parent.append(i),null!=e.touchable&&(i.touchable=e.touchable),e.hidden&&i.hide(),i.id=e.id,e.scene.register(i),i}return o(e,t),Object.defineProperty(e.prototype,"onUpdate",{get:function(){return this._onUpdate||(this._onUpdate=new n.ChainTrigger(this.scene.onUpdate)),this._onUpdate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onMessage",{get:function(){return this._onMessage||(this._onMessage=new n.ChainTrigger(this.scene.onMessage)),this._onMessage},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onPointDown",{get:function(){return this._onPointDown||(this._onPointDown=new n.ChainTrigger(this.scene.onPointDownCapture,this._isTargetOperation,this)),this._onPointDown},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onPointUp",{get:function(){return this._onPointUp||(this._onPointUp=new n.ChainTrigger(this.scene.onPointUpCapture,this._isTargetOperation,this)),this._onPointUp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onPointMove",{get:function(){return this._onPointMove||(this._onPointMove=new n.ChainTrigger(this.scene.onPointMoveCapture,this._isTargetOperation,this)),this._onPointMove},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"touchable",{get:function(){return this._touchable},set:function(t){this._touchable!==t&&(this._touchable=t,t?this._enableTouchPropagation():this._disableTouchPropagation())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"update",{get:function(){return this.onUpdate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.onMessage},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointDown",{get:function(){return this.onPointDown},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointUp",{get:function(){return this.onPointUp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointMove",{get:function(){return this.onPointMove},enumerable:!1,configurable:!0}),e.prototype.render=function(t,e){if(this.state&=-5,!(1&this.state))if(8&this.state){if(t.translate(this.x,this.y),this.renderSelf(t,e)&&this.children)for(var i=(n=this.children).length,r=0;r<i;++r)n[r].render(t,e);t.translate(-this.x,-this.y)}else{t.save(),this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?t.transform(this.getMatrix()._matrix):t.translate(this.x,this.y),1!==this.opacity&&t.opacity(this.opacity);var o=this.compositeOperation;if(void 0!==o&&t.setCompositeOperation("string"==typeof o?o:Q.Util.compositeOperationStringTable[o]),void 0!==this.shaderProgram&&t.isSupportedShaderProgram()&&t.setShaderProgram(this.shaderProgram),this.renderSelf(t,e)&&this.children){var n=this.children;for(r=0;r<n.length;++r)n[r].render(t,e)}t.restore()}},e.prototype.renderSelf=function(t,e){return!0},e.prototype.game=function(){return this.scene.game},e.prototype.append=function(t){this.insertBefore(t,void 0)},e.prototype.insertBefore=function(t,e){t.parent&&t.remove(),this.children||(this.children=[]),t.parent=this;var i=-1;void 0!==e&&(i=this.children.indexOf(e))>-1?this.children.splice(i,0,t):this.children.push(t),(t._touchable||t._hasTouchableChildren)&&(this._hasTouchableChildren=!0,this._enableTouchPropagation()),this.modified(!0)},e.prototype.remove=function(t){if(void 0!==t){var e=this.children?this.children.indexOf(t):-1;if(e<0)throw X.ExceptionFactory.createAssertionError("E#remove: invalid child");this.children[e].parent=void 0,this.children.splice(e,1),(t._touchable||t._hasTouchableChildren)&&(this._findTouchableChildren(this)||(this._hasTouchableChildren=!1,this._disableTouchPropagation())),this.modified(!0)}else this.parent.remove(this)},e.prototype.destroy=function(){if(this.parent&&this.remove(),this.children){for(var t=this.children.length-1;t>=0;--t)this.children[t].destroy();if(0!==this.children.length)throw X.ExceptionFactory.createAssertionError("E#destroy: can not destroy all children, "+this.children.length);this.children=void 0}this._onUpdate&&(this._onUpdate.destroy(),this._onUpdate=void 0),this._onMessage&&(this._onMessage.destroy(),this._onMessage=void 0),this._onPointDown&&(this._onPointDown.destroy(),this._onPointDown=void 0),this._onPointMove&&(this._onPointMove.destroy(),this._onPointMove=void 0),this._onPointUp&&(this._onPointUp.destroy(),this._onPointUp=void 0),this.scene.unregister(this)},e.prototype.destroyed=function(){return void 0===this.scene},e.prototype.modified=function(t){this._matrix&&(this._matrix._modified=!0),this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY||1!==this.opacity||void 0!==this.compositeOperation||void 0!==this.shaderProgram?this.state&=-9:this.state|=8,4&this.state||(this.state|=4,this.parent&&this.parent.modified(!0))},e.prototype.shouldFindChildrenByPoint=function(t){return!0},e.prototype.findPointSourceByPoint=function(t,e,i){if(!(1&this.state)){var r=(e=e?e.multiplyNew(this.getMatrix()):this.getMatrix().clone()).multiplyInverseForPoint(t);if(this._hasTouchableChildren||i&&this.children&&this.children.length){var o=this.children;if(this.shouldFindChildrenByPoint(r))for(var n=o.length-1;n>=0;--n){var s=o[n];if(i||s._touchable||s._hasTouchableChildren){var a=s.findPointSourceByPoint(t,e,i);if(a)return a}}}if(i||this._touchable)return 0<=r.x&&this.width>r.x&&0<=r.y&&this.height>r.y?{target:this,point:r}:void 0}},e.prototype.visible=function(){return 1!=(1&this.state)},e.prototype.show=function(){1&this.state&&(this.state&=-2,this.parent&&this.parent.modified(!0))},e.prototype.hide=function(){1&this.state||(this.state|=1,this.parent&&this.parent.modified(!0))},e.prototype.calculateBoundingRect=function(){return this._calculateBoundingRect(void 0)},e.prototype.localToGlobal=function(t){for(var i=t,r=this;r instanceof e;r=r.parent)i=r.getMatrix().multiplyPoint(i);return i},e.prototype.globalToLocal=function(t){for(var i=new $.PlainMatrix,r=this;r instanceof e;r=r.parent)i.multiplyLeft(r.getMatrix());return i.multiplyInverseForPoint(t)},e.prototype._calculateMatrixTo=function(t){for(var i=new $.PlainMatrix,r=this;r instanceof e&&r!==t;r=r.parent)i.multiplyLeft(r.getMatrix());return i},e.prototype._findLowestCommonAncestorWith=function(t){for(var i={},r=this;r instanceof e;r=r.parent)i[r.id]=!0;for(var o=t;o instanceof e&&!i.hasOwnProperty(o.id);o=o.parent);return o},e.prototype._calculateBoundingRect=function(t){var e=this.getMatrix();if(t&&(e=t.multiplyNew(e)),this.visible()){for(var i={left:0,right:this.width,top:0,bottom:this.height},r=[{x:i.left,y:i.top},{x:i.left,y:i.bottom},{x:i.right,y:i.top},{x:i.right,y:i.bottom}],o=e.multiplyPoint(r[0]),n={left:o.x,right:o.x,top:o.y,bottom:o.y},s=1;s<r.length;++s)o=e.multiplyPoint(r[s]),n.left>o.x&&(n.left=o.x),n.right<o.x&&(n.right=o.x),n.top>o.y&&(n.top=o.y),n.bottom<o.y&&(n.bottom=o.y);if(void 0!==this.children)for(s=0;s<this.children.length;++s){var a=this.children[s]._calculateBoundingRect(e);a&&(n.left>a.left&&(n.left=a.left),n.right<a.right&&(n.right=a.right),n.top>a.top&&(n.top=a.top),n.bottom<a.bottom&&(n.bottom=a.bottom))}return n}},e.prototype._enableTouchPropagation=function(){for(var t=this.parent;t instanceof e&&!t._hasTouchableChildren;)t._hasTouchableChildren=!0,t=t.parent},e.prototype._disableTouchPropagation=function(){for(var t=this.parent;t instanceof e&&t._hasTouchableChildren&&!this._findTouchableChildren(t);)t._hasTouchableChildren=!1,t=t.parent},e.prototype._isTargetOperation=function(t){return!(1&this.state)&&(t instanceof K.PointEventBase&&(this._touchable&&t.target===this))},e.prototype._findTouchableChildren=function(t){if(t.children)for(var e=0;e<t.children.length;++e){if(t.children[e].touchable)return t.children[e];var i=this._findTouchableChildren(t.children[e]);if(i)return i}},e}(Z.Object2D);i.E=c}));e(tt);tt.E,tt.PointMoveEvent,tt.PointUpEvent,tt.PointDownEvent;var et=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.CacheableE=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;return i._shouldRenderChildren=!0,i._cache=void 0,i._renderer=void 0,i._renderedCamera=void 0,i}return o(e,t),e.prototype.invalidate=function(){this.state&=-3,this.modified()},e.prototype.renderSelf=function(t,i){var r=e.PADDING;if(this._renderedCamera!==i&&(this.state&=-3,this._renderedCamera=i),!(2&this.state)){this._cacheSize=this.calculateCacheSize();var o=Math.ceil(this._cacheSize.width)+2*r,n=Math.ceil(this._cacheSize.height)+2*r,s=!this._cache||this._cache.width<o||this._cache.height<n;s&&(this._cache&&!this._cache.destroyed()&&this._cache.destroy(),this._cache=this.scene.game.resourceFactory.createSurface(o,n),this._renderer=this._cache.renderer());var a=this._renderer;a.begin(),s||a.clear(),a.save(),a.translate(r,r),this.renderCache(a,i),a.restore(),this.state|=2,a.end()}return this._cache&&this._cacheSize.width>0&&this._cacheSize.height>0&&(t.translate(-r,-r),this.renderSelfFromCache(t),t.translate(r,r)),this._shouldRenderChildren},e.prototype.renderSelfFromCache=function(t){t.drawImage(this._cache,0,0,this._cacheSize.width+e.PADDING,this._cacheSize.height+e.PADDING,0,0)},e.prototype.destroy=function(){this._cache&&!this._cache.destroyed()&&this._cache.destroy(),this._cache=void 0,t.prototype.destroy.call(this)},e.prototype.calculateCacheSize=function(){return{width:this.width,height:this.height}},e.PADDING=1,e}(tt.E);i.CacheableE=n}));e(et);et.CacheableE;var it=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.FilledRect=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;if("string"!=typeof e.cssColor)throw X.ExceptionFactory.createTypeMismatchError("ColorBox#constructor(cssColor)","string",e.cssColor);return i.cssColor=e.cssColor,i}return o(e,t),e.prototype.renderSelf=function(t){return t.fillRect(0,0,this.width,this.height,this.cssColor),!0},e}(tt.E);i.FilledRect=n}));e(it);it.FilledRect;var rt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SurfaceUtil=void 0,function(t){t.asSurface=function(t){if(t){if("type"in t&&"image"===t.type)return t.asSurface();if("_drawable"in t)return t;throw X.ExceptionFactory.createTypeMismatchError("SurfaceUtil#asSurface","ImageAsset|Surface",t)}},t.setupAnimatingHandler=function(t,e){e.isPlaying()&&t._handleAnimationStart()},t.migrateAnimatingHandler=function(t,e,i){t._handleAnimationStop(),i.isPlaying()&&t._handleAnimationStart()},t.drawNinePatch=function(t,e,i){void 0===i&&(i=4);var r,o=t.renderer(),n=t.width,s=t.height;r="number"==typeof i?{top:i,bottom:i,left:i,right:i}:i,o.begin(),o.clear();for(var a=r.left,h=e.width-r.right,c=r.top,l=e.height-r.bottom,d=r.left,u=n-r.right,p=r.top,f=s-r.bottom,_=[{x:0,y:0,width:r.left,height:r.top},{x:h,y:0,width:r.right,height:r.top},{x:0,y:l,width:r.left,height:r.bottom},{x:h,y:l,width:r.right,height:r.bottom}],y=[{x:0,y:0},{x:u,y:0},{x:0,y:f},{x:u,y:f}],g=0;g<_.length;++g){var v=_[g];o.save(),o.translate(y[g].x,y[g].y),o.drawImage(e,v.x,v.y,v.width,v.height,0,0),o.restore()}var m=[{x:a,y:0,width:h-a,height:r.top},{x:0,y:c,width:r.left,height:l-c},{x:h,y:c,width:r.right,height:l-c},{x:a,y:l,width:h-a,height:r.bottom}],S=[{x:d,y:0,width:u-d,height:r.top},{x:0,y:p,width:r.left,height:f-p},{x:u,y:p,width:r.right,height:f-p},{x:d,y:f,width:u-d,height:r.bottom}];for(g=0;g<m.length;++g){var A=m[g],x=S[g];o.save(),o.translate(x.x,x.y),o.transform([x.width/A.width,0,0,x.height/A.height,0,0]),o.drawImage(e,A.x,A.y,A.width,A.height,0,0),o.restore()}var P=h-a,b=l-c,w=u-d,M=f-p;o.save(),o.translate(d,p),o.transform([w/P,0,0,M/b,0,0]),o.drawImage(e,a,c,P,b,0,0),o.restore(),o.end()}}(e.SurfaceUtil||(e.SurfaceUtil={}))}));e(rt);rt.SurfaceUtil;var ot=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.Sprite=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;return i.src=e.src,"_drawable"in e.src?i._surface=e.src:i._surface=rt.SurfaceUtil.asSurface(e.src),null==e.width&&(i.width=i._surface.width),null==e.height&&(i.height=i._surface.height),i.srcWidth=null!=e.srcWidth?e.srcWidth:i.width,i.srcHeight=null!=e.srcHeight?e.srcHeight:i.height,i.srcX=e.srcX||0,i.srcY=e.srcY||0,i._stretchMatrix=void 0,i._beforeSrc=i.src,i._beforeSurface=i._surface,rt.SurfaceUtil.setupAnimatingHandler(i,i._surface),i._invalidateSelf(),i}return o(e,t),e.prototype._handleUpdate=function(){this.modified()},e.prototype._handleAnimationStart=function(){this.onUpdate.contains(this._handleUpdate,this)||this.onUpdate.add(this._handleUpdate,this)},e.prototype._handleAnimationStop=function(){this.destroyed()||this.onUpdate.remove(this._handleUpdate,this)},e.prototype.renderSelf=function(t,e){return this.srcWidth<=0||this.srcHeight<=0||(this._stretchMatrix&&(t.save(),t.transform(this._stretchMatrix._matrix)),t.drawImage(this._surface,this.srcX,this.srcY,this.srcWidth,this.srcHeight,0,0),this._stretchMatrix&&t.restore()),!0},e.prototype.invalidate=function(){this._invalidateSelf(),this.modified()},e.prototype.destroy=function(e){this._surface&&!this._surface.destroyed()&&e&&this._surface.destroy(),this.src=void 0,this._beforeSrc=void 0,this._surface=void 0,t.prototype.destroy.call(this)},e.prototype._invalidateSelf=function(){this.width===this.srcWidth&&this.height===this.srcHeight?this._stretchMatrix=void 0:(this._stretchMatrix=new $.PlainMatrix,this._stretchMatrix.scale(this.width/this.srcWidth,this.height/this.srcHeight)),this.src!==this._beforeSrc&&(this._beforeSrc=this.src,"_drawable"in this.src?this._surface=this.src:this._surface=rt.SurfaceUtil.asSurface(this.src)),this._surface!==this._beforeSurface&&(rt.SurfaceUtil.migrateAnimatingHandler(this,this._beforeSurface,this._surface),this._beforeSurface=this._surface)},e}(tt.E);i.Sprite=n}));e(ot);ot.Sprite;var nt=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.FrameSprite=void 0;var s=function(t){function e(e){var i=t.call(this,e)||this;return i._lastUsedIndex=0,i.frameNumber=e.frameNumber||0,i.frames=null!=e.frames?e.frames:[0],i.interval=e.interval,i._timer=void 0,i.loop=null==e.loop||e.loop,i.onFinish=new n.Trigger,i.finished=i.onFinish,i._modifiedSelf(),i}return o(e,t),e.createBySprite=function(t,i,r){var o=new e({scene:t.scene,src:t.src,width:void 0===i?t.width:i,height:void 0===r?t.height:r});return o.srcHeight=void 0===r?t.srcHeight:r,o.srcWidth=void 0===i?t.srcWidth:i,o},e.prototype.start=function(){void 0===this.interval&&(this.interval=1e3/this.game().fps),this._timer&&this._free(),this._timer=this.scene.createTimer(this.interval),this._timer.onElapse.add(this._handleElapse,this)},e.prototype.destroy=function(e){this.stop(),t.prototype.destroy.call(this,e)},e.prototype.stop=function(){this._timer&&this._free()},e.prototype.modified=function(e){this._modifiedSelf(e),t.prototype.modified.call(this,e)},e.prototype._handleElapse=function(){this.frameNumber===this.frames.length-1?this.loop?this.frameNumber=0:(this.stop(),this.onFinish.fire()):this.frameNumber++,this.modified()},e.prototype._free=function(){this._timer&&(this._timer.onElapse.remove(this._handleElapse,this),this._timer.canDelete()&&this.scene.deleteTimer(this._timer),this._timer=void 0)},e.prototype._changeFrame=function(){var t=this.frames[this.frameNumber],e=Math.floor(this._surface.width/this.srcWidth);this.srcX=t%e*this.srcWidth,this.srcY=Math.floor(t/e)*this.srcHeight,this._lastUsedIndex=t},e.prototype._modifiedSelf=function(t){this._lastUsedIndex!==this.frames[this.frameNumber]&&this._changeFrame()},e}(ot.Sprite);i.FrameSprite=s}));e(nt);nt.FrameSprite;var st=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TextAlign=void 0,function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(e.TextAlign||(e.TextAlign={}))}));e(st);st.TextAlign;var at=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.Label=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;return i.text=e.text,i.font=e.font,i.textAlign=null!=e.textAlign?e.textAlign:st.TextAlign.Left,i.glyphs=new Array(e.text.length),i.fontSize=null!=e.fontSize?e.fontSize:e.font.size,i.maxWidth=e.maxWidth,i.widthAutoAdjust=null==e.widthAutoAdjust||e.widthAutoAdjust,i.textColor=e.textColor,i._realTextAlign="left",i._textWidth=0,i._overhangLeft=0,i._overhangRight=0,i._invalidateSelf(),i}return o(e,t),e.prototype.aligning=function(t,e){this.width=t,this.widthAutoAdjust=!1,this.textAlign=e},e.prototype.invalidate=function(){this._invalidateSelf(),t.prototype.invalidate.call(this)},e.prototype.renderSelfFromCache=function(t){var e;switch(this._realTextAlign){case"center":e=this.widthAutoAdjust?this._overhangLeft:0;break;case"right":e=this.widthAutoAdjust?this._overhangLeft:this._overhangRight;break;default:e=this._overhangLeft}t.drawImage(this._cache,0,0,this._cacheSize.width+et.CacheableE.PADDING,this._cacheSize.height+et.CacheableE.PADDING,e,0)},e.prototype.renderCache=function(t){if(!(!this.fontSize||this.height<=0||this._textWidth<=0)){var e=this.maxWidth&&this.maxWidth>0&&this.maxWidth<this._textWidth?this.maxWidth/this._textWidth:1,i=0;switch(this._realTextAlign){case"center":i=this.width/2-(this._textWidth+this._overhangLeft)/2*e;break;case"right":i=this.width-(this._textWidth+this._overhangLeft)*e;break;default:i-=this._overhangLeft*e}t.translate(i,0),1!==e&&t.transform([e,0,0,1,0,0]),t.save();for(var r=this.fontSize/this.font.size,o=0;o<this.glyphs.length;++o){var n=this.glyphs[o],s=n.advanceWidth*r,a=n.code;n.isSurfaceValid||(n=this.font.glyphForCharacter(a))?(n.surface&&(t.save(),t.transform([r,0,0,r,0,0]),t.drawImage(n.surface,n.x,n.y,n.width,n.height,n.offsetX,n.offsetY),t.restore()),t.translate(s,0)):this._outputOfWarnLogWithNoGlyph(a,"renderCache()")}t.restore(),t.save(),this.textColor&&(t.setCompositeOperation("source-atop"),t.fillRect(0,0,this._textWidth,this.height,this.textColor)),t.restore()}},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype._invalidateSelf=function(){this.glyphs.length=0,this._textWidth=0;var t=this.textAlign;if(this._realTextAlign="string"==typeof t?t:Q.Util.enumToSnakeCase(st.TextAlign,t),this.fontSize){for(var e=this.text.length-1,i=this.text.length-1;i>=0;--i){var r=Q.Util.charCodeAt(this.text,i);if(r)if((s=this.font.glyphForCharacter(r))&&0!==s.width&&0!==s.advanceWidth){e=i;break}}var o=0,n=this.font.size>0?this.fontSize/this.font.size:0;for(i=0;i<=e;++i){var s,a=Q.Util.charCodeAt(this.text,i);if(a)if(s=this.font.glyphForCharacter(a)){if(!(s.width<0||s.height<0||s.x<0||s.y<0)){this.glyphs.push(s);var h=0;0===i&&(this._overhangLeft=Math.min(s.offsetX,0),h=-this._overhangLeft),i===e&&(this._overhangRight=Math.max(s.width+s.offsetX-s.advanceWidth,0),h+=this._overhangRight),this._textWidth+=(s.advanceWidth+h)*n;var c=s.offsetY+s.height;o<c&&(o=c)}}else this._outputOfWarnLogWithNoGlyph(a,"_invalidateSelf()")}this.widthAutoAdjust&&(this.width=this._textWidth),this.height=o*n}else this.height=0},e.prototype._outputOfWarnLogWithNoGlyph=function(t,e){var i=4294901760&t?String.fromCharCode((4294901760&t)>>>16,65535&t):String.fromCharCode(t);console.warn("Label#"+e+": failed to get a glyph for '"+i+"' (BitmapFont might not have the glyph or DynamicFont might create a glyph larger than its atlas).")},e}(et.CacheableE);i.Label=n}));e(at);at.Label;var ht=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.Pane=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;return i._oldWidth=e.width,i._oldHeight=e.height,i.backgroundImage=e.backgroundImage,i._beforeBackgroundImage=e.backgroundImage,i._backgroundImageSurface=rt.SurfaceUtil.asSurface(e.backgroundImage),i.backgroundEffector=e.backgroundEffector,i._shouldRenderChildren=!1,i._padding=e.padding||0,i._initialize(),i._paddingChanged=!1,i}return o(e,t),Object.defineProperty(e.prototype,"padding",{get:function(){return this._padding},set:function(t){this._padding=t,this._paddingChanged=!0},enumerable:!1,configurable:!0}),e.prototype.modified=function(e){e&&(this.state&=-3),t.prototype.modified.call(this)},e.prototype.shouldFindChildrenByPoint=function(t){var e=this._normalizedPadding;return e.left<t.x&&this.width-e.right>t.x&&e.top<t.y&&this.height-e.bottom>t.y},e.prototype.renderCache=function(t,e){this.width<=0||this.height<=0||(this._renderBackground(),this._renderChildren(e),this._bgSurface?t.drawImage(this._bgSurface,0,0,this.width,this.height,0,0):this._backgroundImageSurface&&t.drawImage(this._backgroundImageSurface,0,0,this.width,this.height,0,0),this._childrenArea.width<=0||this._childrenArea.height<=0||(t.save(),0===this._childrenArea.x&&0===this._childrenArea.y||t.translate(this._childrenArea.x,this._childrenArea.y),t.drawImage(this._childrenSurface,0,0,this._childrenArea.width,this._childrenArea.height,0,0),t.restore()))},e.prototype.destroy=function(e){e&&this._backgroundImageSurface&&!this._backgroundImageSurface.destroyed()&&this._backgroundImageSurface.destroy(),this._bgSurface&&!this._bgSurface.destroyed()&&this._bgSurface.destroy(),this._childrenSurface&&!this._childrenSurface.destroyed()&&this._childrenSurface.destroy(),this.backgroundImage=void 0,this._backgroundImageSurface=void 0,this._beforeBackgroundImage=void 0,this._bgSurface=void 0,this._childrenSurface=void 0,t.prototype.destroy.call(this)},e.prototype._renderBackground=function(){if(this.backgroundImage!==this._beforeBackgroundImage&&(this._backgroundImageSurface=rt.SurfaceUtil.asSurface(this.backgroundImage),this._beforeBackgroundImage=this.backgroundImage),this._backgroundImageSurface&&this.backgroundEffector){var t=this.backgroundEffector.render(this._backgroundImageSurface,this.width,this.height);this._bgSurface!==t&&(this._bgSurface&&!this._bgSurface.destroyed()&&this._bgSurface.destroy(),this._bgSurface=t)}else this._bgSurface=void 0},e.prototype._renderChildren=function(t){var e=this._oldWidth!==this.width||this._oldHeight!==this.height||this._paddingChanged;if(e&&(this._initialize(),this._paddingChanged=!1,this._oldWidth=this.width,this._oldHeight=this.height),this._childrenRenderer.begin(),e||this._childrenRenderer.clear(),this.children)for(var i=this.children,r=0;r<i.length;++r)i[r].render(this._childrenRenderer,t);this._childrenRenderer.end()},e.prototype._initialize=function(){var t,e=this._padding;t="number"==typeof e?{top:e,bottom:e,left:e,right:e}:this._padding,this._childrenArea={x:t.left,y:t.top,width:this.width-t.left-t.right,height:this.height-t.top-t.bottom};var i=this.scene.game.resourceFactory;this._childrenSurface&&!this._childrenSurface.destroyed()&&this._childrenSurface.destroy(),this._childrenSurface=i.createSurface(Math.ceil(this._childrenArea.width),Math.ceil(this._childrenArea.height)),this._childrenRenderer=this._childrenSurface.renderer(),this._normalizedPadding=t},e.prototype._calculateBoundingRect=function(t){var e=this.getMatrix();if(t&&(e=t.multiplyNew(e)),this.visible()){for(var i={left:0,right:this.width,top:0,bottom:this.height},r=[{x:i.left,y:i.top},{x:i.left,y:i.bottom},{x:i.right,y:i.top},{x:i.right,y:i.bottom}],o=e.multiplyPoint(r[0]),n={left:o.x,right:o.x,top:o.y,bottom:o.y},s=1;s<r.length;++s)o=e.multiplyPoint(r[s]),n.left>o.x&&(n.left=o.x),n.right<o.x&&(n.right=o.x),n.top>o.y&&(n.top=o.y),n.bottom<o.y&&(n.bottom=o.y);return n}},e}(et.CacheableE);i.Pane=n}));e(ht);ht.Pane;var ct=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AssetAccessor=void 0;var i=function(){function t(t){this._assetManager=t}return t.prototype.getImage=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"image")},t.prototype.getAudio=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"audio")},t.prototype.getScript=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"script")},t.prototype.getText=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"text")},t.prototype.getTextContent=function(t){return this.getText(t).data},t.prototype.getJSONContent=function(t){return JSON.parse(this.getTextContent(t))},t.prototype.getAllImages=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","image")},t.prototype.getAllAudios=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","audio")},t.prototype.getAllScripts=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","script")},t.prototype.getAllTexts=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","text")},t.prototype.getImageById=function(t){return this._assetManager.peekLiveAssetById(t,"image")},t.prototype.getAudioById=function(t){return this._assetManager.peekLiveAssetById(t,"audio")},t.prototype.getScriptById=function(t){return this._assetManager.peekLiveAssetById(t,"script")},t.prototype.getTextById=function(t){return this._assetManager.peekLiveAssetById(t,"text")},t.prototype.getTextContentById=function(t){return this.getTextById(t).data},t.prototype.getJSONContentById=function(t){return JSON.parse(this.getTextById(t).data)},t}();e.AssetAccessor=i}));e(ct);ct.AssetAccessor;var lt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(lt);var dt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(dt);var ut=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AssetManager=void 0;var i=function(t,e){this.asset=t,this.handlers=[e],this.errorCount=0,this.loading=!1};function r(t){var e=/([^\*\\\?]*)(\\\*|\\\?|\?|\*(?!\*)|\*\*\/|$)/g,i={"":"","\\*":"\\*","\\?":"\\?","*":"[^/]*","?":"[^/]","**/":"(?:^/)?(?:[^/]+/)*"},r=/[\\^$.*+?()[\]{}|]/g;for(var o="",n=e.exec(t);n&&""!==n[0];n=e.exec(t))o+=n[1].replace(r,"\\$&")+i[n[2]];var s=new RegExp("^"+o+"$");return function(t){return s.test(t)}}var o=function(){function t(t,e,i,r){this._resourceFactory=t.resourceFactory,this._audioSystemManager=t.audio,this._defaultAudioSystemId=t.defaultAudioSystemId,this.configuration=this._normalize(e||{},function(t){void 0===t&&(t={});var e={music:{loop:!0,hint:{streaming:!0}},sound:{loop:!1,hint:{streaming:!1}}};for(var i in e)i in t||(t[i]=e[i]);return t}(i)),this._assets={},this._virtualPathToIdTable={},this._liveAssetVirtualPathTable={},this._liveAssetPathTable={},this._moduleMainScripts=r||{},this._refCounts={},this._loadings={};for(var o=Object.keys(this.configuration),n=0;n<o.length;++n){var s=o[n],a=this.configuration[s];this._virtualPathToIdTable[a.virtualPath]=s}}return t.prototype.destroy=function(){for(var t=Object.keys(this._refCounts),e=0;e<t.length;++e)this._releaseAsset(t[e]);this.configuration=void 0,this._assets=void 0,this._liveAssetVirtualPathTable=void 0,this._liveAssetPathTable=void 0,this._refCounts=void 0,this._loadings=void 0},t.prototype.destroyed=function(){return void 0===this._assets},t.prototype.retryLoad=function(e){if(!this._loadings.hasOwnProperty(e.id))throw X.ExceptionFactory.createAssertionError("AssetManager#retryLoad: invalid argument.");var i=this._loadings[e.id];if(i.errorCount>t.MAX_ERROR_COUNT){if(!this.configuration[e.id])return;throw X.ExceptionFactory.createAssertionError("AssetManager#retryLoad: too many retrying.")}i.loading||(i.loading=!0,e._load(this))},t.prototype.globalAssetIds=function(){var t=[],e=this.configuration;for(var i in e)e.hasOwnProperty(i)&&e[i].global&&t.push(i);return t},t.prototype.resolvePatternsToAssetIds=function(t){if(0===t.length)return[];for(var e=Object.keys(this._virtualPathToIdTable),i=[],o=0;o<t.length;++o)for(var n=t[o],s="string"==typeof n?r(this._replaceModulePathToAbsolute(n)):n,a=0;a<e.length;++a){var h=e[a];s("/"+h)&&i.push(this._virtualPathToIdTable[h])}return i},t.prototype.requestAsset=function(t,e){var r,o="string"==typeof t?t:t.id,n=!1;if(this._assets.hasOwnProperty(o))++this._refCounts[o],e._onAssetLoad(this._assets[o]);else if(this._loadings.hasOwnProperty(o))(r=this._loadings[o]).handlers.push(e),++this._refCounts[o],n=!0;else{var s=this._createAssetFor(t);r=new i(s,e),this._loadings[o]=r,this._refCounts[o]=1,n=!0,r.loading=!0,s._load(this)}return n},t.prototype.unrefAsset=function(t){var e="string"==typeof t?t:t.id;--this._refCounts[e]>0||this._releaseAsset(e)},t.prototype.requestAssets=function(t,e){for(var i=0,r=0,o=t.length;r<o;++r)this.requestAsset(t[r],e)&&++i;return i},t.prototype.unrefAssets=function(t){for(var e=0,i=t.length;e<i;++e)this.unrefAsset(t[e])},t.prototype.peekLiveAssetByAccessorPath=function(t,e){if("/"!==(t=this._replaceModulePathToAbsolute(t))[0])throw X.ExceptionFactory.createAssertionError("AssetManager#peekLiveAssetByAccessorPath(): accessorPath must start with '/'");var i=t.slice(1),r=this._liveAssetVirtualPathTable[i];if(!r||e!==r.type)throw X.ExceptionFactory.createAssertionError("AssetManager#peekLiveAssetByAccessorPath(): No "+e+" asset for "+t);return r},t.prototype.peekLiveAssetById=function(t,e){var i=this._assets[t];if(!i||e!==i.type)throw X.ExceptionFactory.createAssertionError("SceneAssetManager#_getById(): No "+e+" asset for id "+t);return i},t.prototype.peekAllLiveAssetsByPattern=function(t,e){for(var i=Object.keys(this._liveAssetVirtualPathTable),o="string"==typeof t?r(this._replaceModulePathToAbsolute(t)):t,n=[],s=0;s<i.length;++s){var a=i[s],h=this._liveAssetVirtualPathTable[a];if(!e||h.type===e)o("/"+a)&&n.push(h)}return n},t.prototype._normalize=function(t,e){var i={};if(!(t instanceof Object))throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: invalid arguments.");for(var r in t)if(t.hasOwnProperty(r)){var o=Object.create(t[r]);if(!o.path)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: No path given for: "+r);if(!o.virtualPath)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: No virtualPath given for: "+r);if(!o.type)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: No type given for: "+r);if("image"===o.type){if("number"!=typeof o.width)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the image asset: "+r);if("number"!=typeof o.height)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the image asset: "+r)}if("audio"===o.type){void 0===o.duration&&(o.duration=0);var n=e[o.systemId];if(void 0===o.loop&&(o.loop=!!n&&!!n.loop),void 0===o.hint&&(o.hint=n?n.hint:{}),"music"!==o.systemId&&"sound"!==o.systemId)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong systemId given for the audio asset: "+r)}if("video"===o.type&&!o.useRealSize){if("number"!=typeof o.width)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the video asset: "+r);if("number"!=typeof o.height)throw X.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the video asset: "+r);o.useRealSize=!1}o.global||(o.global=!1),i[r]=o}return i},t.prototype._createAssetFor=function(t){var e,i,r;if("string"==typeof t)e=t,r=this.configuration[e],i=this.configuration[e].path;else{var o=t;e=o.id,r=o,i=o.uri}var n=this._resourceFactory;if(!r)throw X.ExceptionFactory.createAssertionError("AssetManager#_createAssetFor: unknown asset ID: "+e);switch(r.type){case"image":var s=n.createImageAsset(e,i,r.width,r.height);return s.initialize(r.hint),s;case"audio":var a=r.systemId?this._audioSystemManager[r.systemId]:this._audioSystemManager[this._defaultAudioSystemId];return n.createAudioAsset(e,i,r.duration,a,!!r.loop,r.hint);case"text":return n.createTextAsset(e,i);case"script":return n.createScriptAsset(e,i);case"video":var h=new J.VideoSystem;return n.createVideoAsset(e,i,r.width,r.height,h,!!r.loop,!!r.useRealSize);default:throw X.ExceptionFactory.createAssertionError("AssertionError#_createAssetFor: unknown asset type "+r.type+" for asset ID: "+e)}},t.prototype._releaseAsset=function(t){var e=this._assets[t]||this._loadings[t]&&this._loadings[t].asset,i=null;if(e)if(i=e.path,e.inUse())if("audio"===e.type)e._system.requestDestroy(e);else{if("video"!==e.type)throw X.ExceptionFactory.createAssertionError("AssetManager#unrefAssets: Unsupported in-use "+e.id);e.destroy()}else e.destroy();if(delete this._refCounts[t],delete this._loadings[t],delete this._assets[t],this.configuration[t]){var r=this.configuration[t].virtualPath;r&&this._liveAssetVirtualPathTable.hasOwnProperty(r)&&delete this._liveAssetVirtualPathTable[r],i&&this._liveAssetPathTable.hasOwnProperty(i)&&delete this._liveAssetPathTable[i]}},t.prototype._countLoadingAsset=function(){return Object.keys(this._loadings).length},t.prototype._onAssetError=function(e,i){if(!this.destroyed()&&!e.destroyed()){var r=this._loadings[e.id],o=r.handlers;r.loading=!1,++r.errorCount,r.errorCount>t.MAX_ERROR_COUNT&&i.retriable&&(i=X.ExceptionFactory.createAssetLoadError("Retry limit exceeded",!1,null,i)),i.retriable||delete this._loadings[e.id];for(var n=0;n<o.length;++n)o[n]._onAssetError(e,i,this.retryLoad.bind(this))}},t.prototype._onAssetLoad=function(t){if(!this.destroyed()&&!t.destroyed()){var e=this._loadings[t.id];if(e.loading=!1,delete this._loadings[t.id],this._assets[t.id]=t,this.configuration[t.id]){var i=this.configuration[t.id].virtualPath;if(this._liveAssetVirtualPathTable.hasOwnProperty(i)){if(this._liveAssetVirtualPathTable[i].path!==t.path)throw X.ExceptionFactory.createAssertionError("AssetManager#_onAssetLoad(): duplicated asset path")}else this._liveAssetVirtualPathTable[i]=t;this._liveAssetPathTable.hasOwnProperty(t.path)||(this._liveAssetPathTable[t.path]=i)}for(var r=e.handlers,o=0;o<r.length;++o)r[o]._onAssetLoad(t)}},t.prototype._replaceModulePathToAbsolute=function(t){if("/"===t[0]||"*"===t[0])return t;for(var e in this._moduleMainScripts)if(this._moduleMainScripts.hasOwnProperty(e)&&0===t.lastIndexOf(e,0))return"/node_modules/"+t;return t},t.MAX_ERROR_COUNT=3,t}();e.AssetManager=o}));e(ut);ut.AssetManager;var pt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(pt);var ft=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AudioSystemManager=void 0;var i=function(){function t(t){this._muted=!1,this._initializeAudioSystems(t)}return t.prototype._reset=function(){this._muted=!1,this.music._reset(),this.sound._reset()},t.prototype._setMuted=function(t){this._muted!==t&&(this._muted=t,this.music._setMuted(t),this.sound._setMuted(t))},t.prototype._setPlaybackRate=function(t){this.music._setPlaybackRate(t),this.sound._setPlaybackRate(t)},t.prototype._initializeAudioSystems=function(t){this.music=new q.MusicAudioSystem({id:"music",muted:this._muted,resourceFactory:t}),this.sound=new q.SoundAudioSystem({id:"sound",muted:this._muted,resourceFactory:t})},t.prototype.stopAll=function(){this.music.stopAll(),this.sound.stopAll()},t}();e.AudioSystemManager=i}));e(ft);ft.AudioSystemManager;var _t=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Font=void 0;var i=function(){function t(){}return t.prototype.measureText=function(t){for(var e=0,i=0,r=0,o=null,n=0;n<t.length;n++){var s=Q.Util.charCodeAt(t,n);if(s){var a=this.glyphForCharacter(s);!a||a.x<0||a.y<0||a.width<0||a.height<0||(0===n&&(i=-a.offsetX),o=a,e+=a.advanceWidth)}}return o&&(r=e+o.offsetX+o.width-o.advanceWidth),{width:e,actualBoundingBoxLeft:i,actualBoundingBoxRight:r}},t}();e.Font=i}));e(_t);_t.Font;var yt=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.BitmapFont=void 0;var n=function(t){function e(e){var i=t.call(this)||this;return i.surface=rt.SurfaceUtil.asSurface(e.src),e.glyphInfo?(i.map=e.glyphInfo.map,i.defaultGlyphWidth=e.glyphInfo.width,i.defaultGlyphHeight=e.glyphInfo.height,i.missingGlyph=e.glyphInfo.missingGlyph,i.size=e.glyphInfo.height):(i.map=e.map||{},i.defaultGlyphWidth=e.defaultGlyphWidth||0,i.defaultGlyphHeight=e.defaultGlyphHeight||0,i.missingGlyph=e.missingGlyph,i.size=e.defaultGlyphHeight||0),i}return o(e,t),e.prototype.glyphForCharacter=function(t){var e=this.map[t]||this.missingGlyph;if(!e)return null;var i=void 0===e.width?this.defaultGlyphWidth:e.width,r=void 0===e.height?this.defaultGlyphHeight:e.height,o=e.offsetX||0,n=e.offsetY||0,s=void 0===e.advanceWidth?i:e.advanceWidth,a=0===i||0===r?void 0:this.surface;return{code:t,x:e.x,y:e.y,width:i,height:r,surface:a,offsetX:o,offsetY:n,advanceWidth:s,isSurfaceValid:!0,_atlas:null}},e.prototype.destroy=function(){this.surface&&!this.surface.destroyed()&&this.surface.destroy(),this.map=void 0},e.prototype.destroyed=function(){return!this.map},e}(_t.Font);i.BitmapFont=n}));e(yt);yt.BitmapFont;var gt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(gt);var vt=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.Camera2D=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;return i.local=!!e.local,i.name=e.name,i._modifiedCount=0,i}return o(e,t),e.deserialize=function(t){return new e(t.param)},e.prototype.modified=function(){this._modifiedCount=(this._modifiedCount+1)%32768,this._matrix&&(this._matrix._modified=!0)},e.prototype.serialize=function(){return{param:{local:this.local,name:this.name,x:this.x,y:this.y,width:this.width,height:this.height,opacity:this.opacity,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,anchorX:this.anchorX,anchorY:this.anchorY,compositeOperation:this.compositeOperation}}},e.prototype._applyTransformToRenderer=function(t){this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?t.transform(this.getMatrix()._matrix):t.translate(-this.x,-this.y),1!==this.opacity&&t.opacity(this.opacity)},e.prototype._updateMatrix=function(){this._matrix&&(this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?this._matrix.updateByInverse(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y,this.anchorX,this.anchorY):this._matrix.reset(-this.x,-this.y))},e}(Z.Object2D);i.Camera2D=n}));e(vt);vt.Camera2D;var mt=i((function(t,e){function i(t,e){return t.x*e.y-t.y*e.x}function r(t,e){return{x:t.x-e.x,y:t.y-e.y}}Object.defineProperty(e,"__esModule",{value:!0}),e.Collision=void 0,function(t){t.intersectEntities=function(e,o,n,s){var a=e._findLowestCommonAncestorWith(o);if(!a)return!1;var h=n?{left:n.x,top:n.y,right:n.x+n.width,bottom:n.y+n.height}:{left:0,top:0,right:e.width,bottom:e.height},c=s?{left:s.x,top:s.y,right:s.x+s.width,bottom:s.y+s.height}:{left:0,top:0,right:o.width,bottom:o.height},l=e._calculateMatrixTo(a),d=o._calculateMatrixTo(a),u=l.multiplyPoint({x:h.left,y:h.top}),p=l.multiplyPoint({x:h.right,y:h.top}),f=l.multiplyPoint({x:h.left,y:h.bottom}),_=l.multiplyPoint({x:h.right,y:h.bottom}),y=d.multiplyPoint({x:c.left,y:c.top}),g=d.multiplyPoint({x:c.right,y:c.top}),v=d.multiplyPoint({x:c.left,y:c.bottom}),m=d.multiplyPoint({x:c.right,y:c.bottom}),S=Math.min(u.x,p.x,f.x,_.x),A=Math.max(u.x,p.x,f.x,_.x),x=Math.min(y.x,g.x,v.x,m.x),P=Math.max(y.x,g.x,v.x,m.x);if(A<x||P<S)return!1;var b=Math.min(u.y,p.y,f.y,_.y),w=Math.max(u.y,p.y,f.y,_.y),M=Math.min(y.y,g.y,v.y,m.y),O=Math.max(y.y,g.y,v.y,m.y);if(w<M||O<b)return!1;if(t.intersectLineSegments(u,p,y,g)||t.intersectLineSegments(u,p,g,m)||t.intersectLineSegments(u,p,m,v)||t.intersectLineSegments(u,p,v,y)||t.intersectLineSegments(p,_,y,g)||t.intersectLineSegments(p,_,g,m)||t.intersectLineSegments(p,_,m,v)||t.intersectLineSegments(p,_,v,y)||t.intersectLineSegments(_,f,y,g)||t.intersectLineSegments(_,f,g,m)||t.intersectLineSegments(_,f,m,v)||t.intersectLineSegments(_,f,v,y)||t.intersectLineSegments(f,u,y,g)||t.intersectLineSegments(f,u,g,m)||t.intersectLineSegments(f,u,m,v)||t.intersectLineSegments(f,u,v,y))return!0;var E=i(r(u,p),r(y,p));if(E*i(r(f,u),r(y,u))>=0&&E*i(r(_,f),r(y,f))>=0&&E*i(r(p,_),r(y,_))>=0)return!0;var T=i(r(y,g),r(u,g));return T*i(r(v,y),r(u,y))>=0&&T*i(r(m,v),r(u,v))>=0&&T*i(r(g,m),r(u,m))>=0},t.intersectLineSegments=function(t,e,o,n){var s=r(e,t),a=r(n,o);return i(r(o,t),s)*i(r(n,t),s)<=0&&i(r(t,o),a)*i(r(e,o),a)<=0},t.intersect=function(t,e,i,r,o,n,s,a){return t<=o+s&&o<=t+i&&e<=n+a&&n<=e+r},t.intersectAreas=function(e,i){return t.intersect(e.x,e.y,e.width,e.height,i.x,i.y,i.width,i.height)},t.within=function(t,e,i,r,o){return void 0===o&&(o=1),o>=Q.Util.distance(t,e,i,r)},t.withinAreas=function(t,e,i){return void 0===i&&(i=1),i>=Q.Util.distanceBetweenAreas(t,e)}}(e.Collision||(e.Collision={}))}));e(mt);mt.Collision;var St=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AssetHolder=void 0;var i=function(){function t(t){var e=t.assetManager,i=t.assetIds?t.assetIds.concat():[];i.push.apply(i,e.resolvePatternsToAssetIds(t.assetPaths||[])),this.waitingAssetsCount=i.length,this.userData=t.userData,this._assetManager=e,this._assetIds=i,this._assets=[],this._handlerSet=t.handlerSet,this._requested=!1}return t.prototype.request=function(){return 0!==this.waitingAssetsCount&&(this._requested||(this._requested=!0,this._assetManager.requestAssets(this._assetIds,this)),!0)},t.prototype.destroy=function(){this._requested&&this._assetManager.unrefAssets(this._assets),this.waitingAssetsCount=0,this.userData=void 0,this._handlerSet=void 0,this._assetIds=void 0,this._requested=!1},t.prototype.destroyed=function(){return!this._handlerSet},t.prototype._onAssetError=function(t,e){var i=this._handlerSet;if(!this.destroyed()&&!i.owner.destroyed()){var r={asset:t,error:e,cancelRetry:!1};i.handleLoadFailure.call(i.owner,r),e.retriable&&!r.cancelRetry?this._assetManager.retryLoad(t):this._assetManager.configuration[t.id]&&i.handleFinish.call(i.owner,this,!1)}},t.prototype._onAssetLoad=function(t){var e=this._handlerSet;if(!(this.destroyed()||e.owner.destroyed()||(e.handleLoad.call(e.owner,t),this._assets.push(t),--this.waitingAssetsCount,this.waitingAssetsCount>0))){if(this.waitingAssetsCount<0)throw X.ExceptionFactory.createAssertionError("AssetHolder#_onAssetLoad: broken waitingAssetsCount");e.handleFinish.call(e.owner,this,!0)}},t}();e.AssetHolder=i}));e(St);St.AssetHolder;var At=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Timer=void 0;var i=function(){function t(t,e){this.interval=t,this._scaledInterval=Math.round(t*e),this.onElapse=new n.Trigger,this.elapsed=this.onElapse,this._scaledElapsed=0}return t.prototype.tick=function(){for(this._scaledElapsed+=1e3;this._scaledElapsed>=this._scaledInterval&&this.onElapse;)this.onElapse.fire(),this._scaledElapsed-=this._scaledInterval},t.prototype.canDelete=function(){return!this.onElapse||0===this.onElapse.length},t.prototype.destroy=function(){this.interval=void 0,this.onElapse.destroy(),this.onElapse=void 0,this.elapsed=void 0,this._scaledInterval=0,this._scaledElapsed=0},t.prototype.destroyed=function(){return void 0===this.onElapse},t}();e.Timer=i}));e(At);At.Timer;var xt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TimerManager=e.TimerIdentifier=void 0;var i=function(){function t(t,e,i,r,o){this._timer=t,this._handler=e,this._handlerOwner=i,this._fired=r,this._firedOwner=o,this._timer.onElapse.add(this._handleElapse,this)}return t.prototype.destroy=function(){this._timer.onElapse.remove(this._handleElapse,this),this._timer=void 0,this._handler=void 0,this._handlerOwner=void 0,this._fired=void 0,this._firedOwner=void 0},t.prototype.destroyed=function(){return void 0===this._timer},t.prototype._handleElapse=function(){this.destroyed()||(this._handler.call(this._handlerOwner),this._fired&&this._fired.call(this._firedOwner,this))},t}();e.TimerIdentifier=i;var r=function(){function t(t,e){this._timers=[],this._trigger=t,this._identifiers=[],this._fps=e,this._registered=!1}return t.prototype.destroy=function(){for(var t=0;t<this._identifiers.length;++t)this._identifiers[t].destroy();for(t=0;t<this._timers.length;++t)this._timers[t].destroy();this._timers=void 0,this._trigger=void 0,this._identifiers=void 0,this._fps=void 0},t.prototype.destroyed=function(){return void 0===this._timers},t.prototype.createTimer=function(t){if(this._registered||(this._trigger.add(this._tick,this),this._registered=!0),t<0)throw X.ExceptionFactory.createAssertionError("TimerManager#createTimer: invalid interval");t<1&&(t=1);for(var e=Math.min(1e3,t*this._fps),i=0;i<this._timers.length;++i)if(this._timers[i].interval===t&&this._timers[i]._scaledElapsed<e)return this._timers[i];var r=new At.Timer(t,this._fps);return this._timers.push(r),r},t.prototype.deleteTimer=function(t){if(t.canDelete()){var e=this._timers.indexOf(t);if(e<0)throw X.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: can not find timer");if(this._timers.splice(e,1),t.destroy(),!this._timers.length){if(!this._registered)throw X.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: handler is not handled");this._trigger.remove(this._tick,this),this._registered=!1}}},t.prototype.setTimeout=function(t,e,r){var o=this.createTimer(e),n=new i(o,t,r,this._onTimeoutFired,this);return this._identifiers.push(n),n},t.prototype.clearTimeout=function(t){this._clear(t)},t.prototype.setInterval=function(t,e,r){var o=this.createTimer(e),n=new i(o,t,r);return this._identifiers.push(n),n},t.prototype.clearInterval=function(t){this._clear(t)},t.prototype._tick=function(){for(var t=this._timers.concat(),e=0;e<t.length;++e)t[e].tick()},t.prototype._onTimeoutFired=function(t){var e=this._identifiers.indexOf(t);if(e<0)throw X.ExceptionFactory.createAssertionError("TimerManager#_onTimeoutFired: can not find identifier");this._identifiers.splice(e,1);var i=t._timer;t.destroy(),this.deleteTimer(i)},t.prototype._clear=function(t){var e=this._identifiers.indexOf(t);if(e<0)throw X.ExceptionFactory.createAssertionError("TimerManager#_clear: can not find identifier");if(t.destroyed())throw X.ExceptionFactory.createAssertionError("TimerManager#_clear: invalid identifier");this._identifiers.splice(e,1);var i=t._timer;t.destroy(),this.deleteTimer(i)},t}();e.TimerManager=r}));e(xt);xt.TimerManager,xt.TimerIdentifier;var Pt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Scene=void 0;var i=function(){function t(t){var e=t.game,i=void 0===t.local||!1===t.local?"non-local":!0===t.local?"full-local":t.local,r=void 0!==t.tickGenerationMode?t.tickGenerationMode:"by-clock";t.storageKeys?(this._storageLoader=e.storage._createLoader(t.storageKeys,t.storageValuesSerialization),this.storageValues=this._storageLoader._valueStore):(this._storageLoader=void 0,this.storageValues=void 0),this.name=t.name,this.game=e,this.local=i,this.tickGenerationMode=r,this.onLoad=new n.Trigger,this.loaded=this.onLoad,this._onReady=new n.Trigger,this._ready=this._onReady,this.assets={},this.asset=new ct.AssetAccessor(e._assetManager),this._loaded=!1,this._prefetchRequested=!1,this._loadingState="initial",this.onUpdate=new n.Trigger,this.update=this.onUpdate,this._timer=new xt.TimerManager(this.onUpdate,this.game.fps),this.onAssetLoad=new n.Trigger,this.onAssetLoadFailure=new n.Trigger,this.onAssetLoadComplete=new n.Trigger,this.assetLoaded=this.onAssetLoad,this.assetLoadFailed=this.onAssetLoadFailure,this.assetLoadCompleted=this.onAssetLoadComplete,this.onMessage=new n.Trigger,this.onPointDownCapture=new n.Trigger,this.onPointMoveCapture=new n.Trigger,this.onPointUpCapture=new n.Trigger,this.onOperation=new n.Trigger,this.message=this.onMessage,this.pointDownCapture=this.onPointDownCapture,this.pointMoveCapture=this.onPointMoveCapture,this.pointUpCapture=this.onPointUpCapture,this.operation=this.onOperation,this.children=[],this.state="standby",this.onStateChange=new n.Trigger,this._assetHolders=[],this._sceneAssetHolder=new St.AssetHolder({assetManager:this.game._assetManager,assetIds:t.assetIds,assetPaths:t.assetPaths,handlerSet:{owner:this,handleLoad:this._handleSceneAssetLoad,handleLoadFailure:this._handleSceneAssetLoadFailure,handleFinish:this._handleSceneAssetLoadFinish},userData:null})}return t.prototype.modified=function(t){this.game.modified()},t.prototype.destroy=function(){this.state="before-destroyed",this.onStateChange.fire(this.state);var t=this.game.db;for(var e in t)t.hasOwnProperty(e)&&t[e].scene===this&&t[e].destroy();t=this.game._localDb;for(var e in t)t.hasOwnProperty(e)&&t[e].scene===this&&t[e].destroy();this._timer.destroy(),this.onUpdate.destroy(),this.onMessage.destroy(),this.onPointDownCapture.destroy(),this.onPointMoveCapture.destroy(),this.onPointUpCapture.destroy(),this.onOperation.destroy(),this.onLoad.destroy(),this.onAssetLoad.destroy(),this.onAssetLoadFailure.destroy(),this.onAssetLoadComplete.destroy(),this.assets={};for(var i=0;i<this._assetHolders.length;++i)this._assetHolders[i].destroy();this._sceneAssetHolder.destroy(),this._storageLoader=void 0,this.game=void 0,this.state="destroyed",this.onStateChange.fire(this.state),this.onStateChange.destroy()},t.prototype.destroyed=function(){return void 0===this.game},t.prototype.createTimer=function(t){return this._timer.createTimer(t)},t.prototype.deleteTimer=function(t){this._timer.deleteTimer(t)},t.prototype.setInterval=function(t,e,i){return this._timer.setInterval(t,e,i)},t.prototype.clearInterval=function(t){this._timer.clearInterval(t)},t.prototype.setTimeout=function(t,e,i){return this._timer.setTimeout(t,e,i)},t.prototype.clearTimeout=function(t){this._timer.clearTimeout(t)},t.prototype.isCurrentScene=function(){return this.game.scene()===this},t.prototype.gotoScene=function(t,e){if(!this.isCurrentScene())throw X.ExceptionFactory.createAssertionError("Scene#gotoScene: this scene is not the current scene");e?this.game.pushScene(t):this.game.replaceScene(t)},t.prototype.end=function(){if(!this.isCurrentScene())throw X.ExceptionFactory.createAssertionError("Scene#end: this scene is not the current scene");this.game.popScene()},t.prototype.register=function(t){this.game.register(t),t.scene=this},t.prototype.unregister=function(t){t.scene=void 0,this.game.unregister(t)},t.prototype.append=function(t){this.insertBefore(t,void 0)},t.prototype.insertBefore=function(t,e){t.parent&&t.remove(),t.parent=this;var i=-1;void 0!==e&&(i=this.children.indexOf(e))>-1?this.children.splice(i,0,t):this.children.push(t),this.modified(!0)},t.prototype.remove=function(t){var e=this.children.indexOf(t);-1!==e&&(this.children[e].parent=void 0,this.children.splice(e,1),this.modified(!0))},t.prototype.findPointSourceByPoint=function(t,e,i){for(var r="non-local"!==this.local,o=this.children,n=i&&i instanceof vt.Camera2D?i.getMatrix():void 0,s=o.length-1;s>=0;--s){var a=o[s].findPointSourceByPoint(t,n,e);if(a)return a.local=a.target&&a.target.local||r,a}return{target:void 0,point:void 0,local:r}},t.prototype.prefetch=function(){this._loaded||this._prefetchRequested||(this._prefetchRequested=!0,this._sceneAssetHolder.request())},t.prototype.serializeStorageValues=function(){if(this._storageLoader)return this._storageLoader._valueStoreSerialization},t.prototype.requestAssets=function(t,e){var i=this;if("ready-fired"!==this._loadingState&&"loaded-fired"!==this._loadingState)throw X.ExceptionFactory.createAssertionError("Scene#requestAsset(): can be called after loaded.");var r=new St.AssetHolder({assetManager:this.game._assetManager,assetIds:t,handlerSet:{owner:this,handleLoad:this._handleSceneAssetLoad,handleLoadFailure:this._handleSceneAssetLoadFailure,handleFinish:this._handleSceneAssetLoadFinish},userData:function(){i.destroyed()||e()}});this._assetHolders.push(r),r.request()},t.prototype._activate=function(){this.state="active",this.onStateChange.fire(this.state)},t.prototype._deactivate=function(){this.state="deactive",this.onStateChange.fire(this.state)},t.prototype._needsLoading=function(){return this._sceneAssetHolder.waitingAssetsCount>0||!!this._storageLoader&&!this._storageLoader._loaded},t.prototype._load=function(){if(!this._loaded){this._loaded=!0;var t=this._sceneAssetHolder.request();this._storageLoader&&(this._storageLoader._load(this),t=!0),t||this._notifySceneReady()}},t.prototype._handleSceneAssetLoad=function(t){this.assets[t.id]=t,this.onAssetLoad.fire(t),this.onAssetLoadComplete.fire(t)},t.prototype._handleSceneAssetLoadFailure=function(t){this.onAssetLoadFailure.fire(t),this.onAssetLoadComplete.fire(t.asset)},t.prototype._handleSceneAssetLoadFinish=function(t,e){e?t.userData?this.game._pushPostTickTask(t.userData,null):this._loaded&&(this._storageLoader&&!this._storageLoader._loaded||this._notifySceneReady()):this.game.terminateGame()},t.prototype._onStorageLoadError=function(t){this.game.terminateGame()},t.prototype._onStorageLoaded=function(){0===this._sceneAssetHolder.waitingAssetsCount&&this._notifySceneReady()},t.prototype._notifySceneReady=function(){this._loadingState="ready",this.game._pushPostTickTask(this._fireReady,this)},t.prototype._fireReady=function(){this.destroyed()||(this._onReady.fire(this),this._loadingState="ready-fired")},t.prototype._fireLoaded=function(){this.destroyed()||"loaded-fired"!==this._loadingState&&(this.onLoad.fire(this),this._loadingState="loaded-fired")},t}();e.Scene=i}));e(Pt);Pt.Scene;var bt=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.LoadingScene=void 0;var s=function(t){function e(e){var i=this;return e.local=!0,(i=t.call(this,e)||this).onTargetReset=new n.Trigger,i.onTargetReady=new n.Trigger,i.onTargetAssetLoad=new n.Trigger,i.targetReset=i.onTargetReset,i.targetReady=i.onTargetReady,i.targetAssetLoaded=i.onTargetAssetLoad,i._explicitEnd=!!e.explicitEnd,i._targetScene=void 0,i}return o(e,t),e.prototype.destroy=function(){this._clearTargetScene(),t.prototype.destroy.call(this)},e.prototype.reset=function(t){this._clearTargetScene(),this._targetScene=t,"loaded-fired"!==this._loadingState?this.onLoad.addOnce(this._doReset,this):this._doReset()},e.prototype.getTargetWaitingAssetsCount=function(){return this._targetScene?this._targetScene._sceneAssetHolder.waitingAssetsCount:0},e.prototype.end=function(){if(!this._targetScene||"initial"===this._targetScene._loadingState){var t="LoadingScene#end(): the target scene is in invalid state: "+(this._targetScene?this._targetScene._loadingState:"(no scene)");throw X.ExceptionFactory.createAssertionError(t)}this.game.popScene(!0),this.game._pushPostTickTask(this._targetScene._fireLoaded,this._targetScene),this._clearTargetScene()},e.prototype._clearTargetScene=function(){this._targetScene&&(this._targetScene._onReady.removeAll({owner:this}),this._targetScene.onAssetLoad.removeAll({owner:this}),this._targetScene=void 0)},e.prototype._doReset=function(){this.onTargetReset.fire(this._targetScene),"initial"===this._targetScene._loadingState||"ready"===this._targetScene._loadingState?(this._targetScene._onReady.add(this._handleReady,this),this._targetScene.onAssetLoad.add(this._handleAssetLoad,this),this._targetScene._load()):this._handleReady(this._targetScene)},e.prototype._handleAssetLoad=function(t){this.onTargetAssetLoad.fire(t)},e.prototype._handleReady=function(t){this.onTargetReady.fire(t),this._explicitEnd||this.end()},e}(Pt.Scene);i.LoadingScene=s}));e(bt);bt.LoadingScene;var wt=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.DefaultLoadingScene=void 0;var n=function(t){function e(e){var i=t.call(this,e)||this;return i._canceller=new Z.Object2D,i}return o(e,t),e.prototype.renderSelf=function(t,e){if(!this.children)return!1;if(e){var i=e,r=this._canceller;i.x===r.x&&i.y===r.y&&i.angle===r.angle&&i.scaleX===r.scaleX&&i.scaleY===r.scaleY||(r.x=i.x,r.y=i.y,r.angle=i.angle,r.scaleX=i.scaleX,r.scaleY=i.scaleY,r._matrix&&(r._matrix._modified=!0)),t.save(),t.transform(r.getMatrix()._matrix)}for(var o=this.children,n=0;n<o.length;++n)o[n].render(t,e);return e&&t.restore(),!1},e}(tt.E),s=function(t){function e(e){var i=t.call(this,{game:e.game,name:"akashic:default-loading-scene"})||this;return"compact"===e.style?(i._barWidth=i.game.width/4,i._barHeight=5,i._style="compact"):(i._barWidth=Math.min(i.game.width,Math.max(100,i.game.width/2)),i._barHeight=5,i._style="default"),i._gauge=void 0,i._gaugeUpdateCount=0,i._totalWaitingAssetCount=0,i.onLoad.add(i._handleLoad,i),i.onTargetReset.add(i._handleTargetReset,i),i.onTargetAssetLoad.add(i._handleTargetAssetLoad,i),i}return o(e,t),e.prototype._handleLoad=function(){var t,e,i,r;if("compact"===this._style){var o=.05*Math.min(this.game.width,this.game.height);t=this.game.width-o-this._barWidth,e=this.game.height-o-this._barHeight,i="transparent"}else t=(this.game.width-this._barWidth)/2,e=(this.game.height-this._barHeight)/2,i="rgba(0, 0, 0, 0.8)";return this.append(new n({scene:this,children:[new it.FilledRect({scene:this,width:this.game.width,height:this.game.height,cssColor:i,children:[new it.FilledRect({scene:this,x:t,y:e,width:this._barWidth,height:this._barHeight,cssColor:"gray",children:[r=new it.FilledRect({scene:this,width:0,height:this._barHeight,cssColor:"white"})]})]})]})),r.onUpdate.add(this._handleUpdate,this),this._gauge=r,!0},e.prototype._handleUpdate=function(){++this._gaugeUpdateCount;var t=Math.round(205+50*Math.sin(this._gaugeUpdateCount/this.game.fps*(2/3)*(2*Math.PI)));this._gauge.cssColor="rgb("+t+","+t+","+t+")",this._gauge.modified()},e.prototype._handleTargetReset=function(t){this._gauge&&(this._gauge.width=0,this._gauge.modified()),this._totalWaitingAssetCount=t._sceneAssetHolder.waitingAssetsCount},e.prototype._handleTargetAssetLoad=function(t){var e=this._targetScene._sceneAssetHolder.waitingAssetsCount;this._gauge.width=Math.ceil((1-e/this._totalWaitingAssetCount)*this._barWidth),this._gauge.modified()},e}(bt.LoadingScene);i.DefaultLoadingScene=s}));e(wt);wt.DefaultLoadingScene;var Mt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Mt);var Ot=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SurfaceAtlasSlot=void 0;var i=function(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r,this.prev=null,this.next=null};e.SurfaceAtlasSlot=i}));e(Ot);Ot.SurfaceAtlasSlot;var Et=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SurfaceAtlas=void 0;var i=function(){function t(t){this._surface=t,this._emptySurfaceAtlasSlotHead=new Ot.SurfaceAtlasSlot(0,0,this._surface.width,this._surface.height),this._accessScore=0,this._usedRectangleAreaSize={width:0,height:0}}return t.prototype.reset=function(){var t=this._surface.renderer();t.begin(),t.clear(),t.end(),this._emptySurfaceAtlasSlotHead=new Ot.SurfaceAtlasSlot(0,0,this._surface.width,this._surface.height),this._accessScore=0,this._usedRectangleAreaSize.width=0,this._usedRectangleAreaSize.height=0},t.prototype._acquireSurfaceAtlasSlot=function(t,e){t+=1,e+=1;var i=function(t,e,i){for(;t;){if(t.width>=e&&t.height>=i)return t;t=t.next}return null}(this._emptySurfaceAtlasSlotHead,t,e);if(!i)return null;var r,o,n=i.width-t,s=i.height-e;n<=s?(r=new Ot.SurfaceAtlasSlot(i.x+t,i.y,n,e),o=new Ot.SurfaceAtlasSlot(i.x,i.y+e,i.width,s)):(r=new Ot.SurfaceAtlasSlot(i.x,i.y+e,t,s),o=new Ot.SurfaceAtlasSlot(i.x+t,i.y,n,i.height)),r.prev=i.prev,r.next=o,null===r.prev?this._emptySurfaceAtlasSlotHead=r:r.prev.next=r,o.prev=r,o.next=i.next,o.next&&(o.next.prev=o);var a=new Ot.SurfaceAtlasSlot(i.x,i.y,t,e);return this._updateUsedRectangleAreaSize(a),a},t.prototype._updateUsedRectangleAreaSize=function(t){var e=t.x+t.width,i=t.y+t.height;e>this._usedRectangleAreaSize.width&&(this._usedRectangleAreaSize.width=e),i>this._usedRectangleAreaSize.height&&(this._usedRectangleAreaSize.height=i)},t.prototype.addSurface=function(t,e,i,r,o){var n=this._acquireSurfaceAtlasSlot(r,o);if(!n)return null;var s=this._surface.renderer();return s.begin(),s.drawImage(t,e,i,r,o,n.x,n.y),s.end(),n},t.prototype.destroy=function(){this._surface.destroy()},t.prototype.destroyed=function(){return this._surface.destroyed()},t.prototype.getAtlasUsedSize=function(){return this._usedRectangleAreaSize},t.prototype.getAccessScore=function(){return this._accessScore},t}();e.SurfaceAtlas=i}));e(Et);Et.SurfaceAtlas;var Tt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SurfaceAtlasSet=void 0;var i=function(){function t(e){this._surfaceAtlases=[],this._atlasGlyphsTable=[],this._resourceFactory=e.resourceFactory,this._currentAtlasIndex=0;var i=e.hint?e.hint:{};this._maxAtlasNum=i.maxAtlasNum?i.maxAtlasNum:t.INITIAL_MAX_SURFACEATLAS_NUM,i.initialAtlasWidth=i.initialAtlasWidth?i.initialAtlasWidth:512,i.initialAtlasHeight=i.initialAtlasHeight?i.initialAtlasHeight:512,i.maxAtlasWidth=i.maxAtlasWidth?i.maxAtlasWidth:512,i.maxAtlasHeight=i.maxAtlasHeight?i.maxAtlasHeight:512,this._atlasSize=function(t){return{width:Math.ceil(Math.min(t.initialAtlasWidth,t.maxAtlasWidth)),height:Math.ceil(Math.min(t.initialAtlasHeight,t.maxAtlasHeight))}}(i)}return t.prototype._deleteAtlas=function(t){for(var e=0;e<t;++e){var i=this._spliceLeastFrequentlyUsedAtlas();if(!i)return;i.destroy()}},t.prototype._findLeastFrequentlyUsedAtlasIndex=function(){for(var t=Number.MAX_VALUE,e=-1,i=0;i<this._surfaceAtlases.length;++i)this._surfaceAtlases[i]._accessScore<=t&&(t=this._surfaceAtlases[i]._accessScore,e=i);return e},t.prototype._spliceLeastFrequentlyUsedAtlas=function(){var t=this._findLeastFrequentlyUsedAtlasIndex();if(-1===t)return null;this._currentAtlasIndex>=t&&--this._currentAtlasIndex;for(var e=this._surfaceAtlases.splice(t,1)[0],i=this._atlasGlyphsTable.splice(t,1)[0],r=0;r<i.length;r++){var o=i[r];o.surface=void 0,o.isSurfaceValid=!1,o._atlas=null}return e},t.prototype._moveGlyphSurface=function(t){for(var e=0;e<this._surfaceAtlases.length;++e){var i=(this._currentAtlasIndex+e)%this._surfaceAtlases.length,r=this._surfaceAtlases[i],o=r.addSurface(t.surface,t.x,t.y,t.width,t.height);if(o)return this._currentAtlasIndex=i,t.surface&&t.surface.destroy(),t.surface=r._surface,t.x=o.x,t.y=o.y,t._atlas=r,this._atlasGlyphsTable[i].push(t),!0}return!1},t.prototype._reallocateAtlas=function(){var t=null;this._surfaceAtlases.length>=this._maxAtlasNum?(t=this._spliceLeastFrequentlyUsedAtlas()).reset():t=new Et.SurfaceAtlas(this._resourceFactory.createSurface(this._atlasSize.width,this._atlasSize.height)),this._surfaceAtlases.push(t),this._atlasGlyphsTable.push([]),this._currentAtlasIndex=this._surfaceAtlases.length-1},t.prototype.getAtlas=function(t){return this._surfaceAtlases[t]},t.prototype.getAtlasNum=function(){return this._surfaceAtlases.length},t.prototype.getMaxAtlasNum=function(){return this._maxAtlasNum},t.prototype.changeMaxAtlasNum=function(t){if(this._maxAtlasNum=t,this._surfaceAtlases.length>this._maxAtlasNum){var e=this._surfaceAtlases.length-this._maxAtlasNum;this._deleteAtlas(e)}},t.prototype.getAtlasUsedSize=function(){return this._atlasSize},t.prototype.addGlyph=function(t){return!(t.width>this._atlasSize.width||t.height>this._atlasSize.height)&&(!!this._moveGlyphSurface(t)||(this._reallocateAtlas(),this._moveGlyphSurface(t)))},t.prototype.touchGlyph=function(t){t._atlas&&(t._atlas._accessScore+=1);for(var e=0;e<this._surfaceAtlases.length;e++){this._surfaceAtlases[e]._accessScore/=2}},t.prototype.destroy=function(){for(var t=0;t<this._surfaceAtlases.length;++t)this._surfaceAtlases[t].destroy();this._surfaceAtlases=void 0,this._resourceFactory=void 0,this._atlasGlyphsTable=void 0},t.prototype.destroyed=function(){return void 0===this._surfaceAtlases},t.INITIAL_MAX_SURFACEATLAS_NUM=10,t}();e.SurfaceAtlasSet=i}));e(Tt);Tt.SurfaceAtlasSet;var Ct=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.DynamicFont=void 0;var n=function(t){function e(e){var i=t.call(this)||this;i.fontFamily=e.fontFamily,i.size=e.size,i.hint=null!=e.hint?e.hint:{},i.fontColor=null!=e.fontColor?e.fontColor:"black",i.fontWeight=null!=e.fontWeight?e.fontWeight:N.FontWeight.Normal,i.strokeWidth=null!=e.strokeWidth?e.strokeWidth:0,i.strokeColor=null!=e.strokeColor?e.strokeColor:"black",i.strokeOnly=null!=e.strokeOnly&&e.strokeOnly;var r=e.game;i._resourceFactory=r.resourceFactory;var o,n=i.fontFamily;if("string"==typeof n)o=n;else if(Array.isArray(n)){for(var s=[],a=0;a<n.length;++a){var h=n[a];s.push("string"==typeof h?h:Q.Util.enumToSnakeCase(N.FontFamily,h))}o=s}else{(s=[]).push("string"==typeof n?n:Q.Util.enumToSnakeCase(N.FontFamily,n)),o=s}var c=i.fontWeight,l="string"==typeof c?c:Q.Util.enumToSnakeCase(N.FontWeight,c);if(i._glyphFactory=i._resourceFactory.createGlyphFactory(o,i.size,i.hint.baselineHeight,i.fontColor,i.strokeWidth,i.strokeColor,i.strokeOnly,l),i._glyphs={},i._destroyed=!1,i._isSurfaceAtlasSetOwner=!1,e.surfaceAtlasSet?i._atlasSet=e.surfaceAtlasSet:e.hint?(i._isSurfaceAtlasSetOwner=!0,i._atlasSet=new Tt.SurfaceAtlasSet({resourceFactory:r.resourceFactory,hint:i.hint})):i._atlasSet=r.surfaceAtlasSet,i.hint.presetChars){a=0;for(var d=i.hint.presetChars.length;a<d;a++){var u=Q.Util.charCodeAt(i.hint.presetChars,a);u&&i.glyphForCharacter(u)}}return i}return o(e,t),e.prototype.glyphForCharacter=function(t){var e=this._glyphs[t];if(!e||!e.isSurfaceValid){if((e=this._glyphFactory.create(t)).surface&&!this._atlasSet.addGlyph(e))return null;this._glyphs[t]=e}return this._atlasSet.touchGlyph(e),e},e.prototype.asBitmapFont=function(t){var e=this;if(1!==this._atlasSet.getAtlasNum())return null;var i=null;t&&(i=Q.Util.charCodeAt(t,0),this.glyphForCharacter(i));var r={};Object.keys(this._glyphs).forEach((function(t){var i=Number(t),o=e._glyphs[i],n={x:o.x,y:o.y,width:o.width,height:o.height,offsetX:o.offsetX,offsetY:o.offsetY,advanceWidth:o.advanceWidth};r[i]=n}));var o=r[i],n=this._atlasSet.getAtlas(0),s=n.getAtlasUsedSize(),a=this._resourceFactory.createSurface(s.width,s.height),h=a.renderer();return h.begin(),h.drawImage(n._surface,0,0,s.width,s.height,0,0),h.end(),new yt.BitmapFont({src:a,map:r,defaultGlyphWidth:0,defaultGlyphHeight:this.size,missingGlyph:o})},e.prototype.destroy=function(){this._isSurfaceAtlasSetOwner&&this._atlasSet.destroy(),this._glyphs=void 0,this._glyphFactory=void 0,this._destroyed=!0},e.prototype.destroyed=function(){return this._destroyed},e}(_t.Font);i.DynamicFont=n}));e(Ct);Ct.DynamicFont;var Lt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Lt);var Ft=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Storage=e.StorageLoader=e.StorageValueStore=e.StorageCountsOperation=e.StorageCondition=e.StorageOrder=e.StorageRegion=void 0,function(t){t[t.Slots=1]="Slots",t[t.Scores=2]="Scores",t[t.Counts=3]="Counts",t[t.Values=4]="Values"}(e.StorageRegion||(e.StorageRegion={})),function(t){t[t.Asc=0]="Asc",t[t.Desc=1]="Desc"}(e.StorageOrder||(e.StorageOrder={})),function(t){t[t.Equal=1]="Equal",t[t.GreaterThan=2]="GreaterThan",t[t.LessThan=3]="LessThan"}(e.StorageCondition||(e.StorageCondition={})),function(t){t[t.Incr=1]="Incr",t[t.Decr=2]="Decr"}(e.StorageCountsOperation||(e.StorageCountsOperation={}));var i=function(){function t(t,e){this._keys=t,this._values=e}return t.prototype.get=function(t){if(void 0===this._values)return[];if("number"==typeof t)return this._values[t];var e=this._keys.indexOf(t);if(-1!==e)return this._values[e];for(var i=0;i<this._keys.length;++i){var r=this._keys[i];if(r.region===t.region&&r.regionKey===t.regionKey&&r.userId===t.userId&&r.gameId===t.gameId)return this._values[i]}return[]},t.prototype.getOne=function(t){var e=this.get(t);if(e)return e[0]},t}();e.StorageValueStore=i;var r=function(){function t(t,e,r){this._loaded=!1,this._storage=t,this._valueStore=new i(e),this._handler=void 0,this._valueStoreSerialization=r}return t.prototype._load=function(t){this._handler=t,this._storage._load&&this._storage._load.call(this._storage,this._valueStore._keys,this,this._valueStoreSerialization)},t.prototype._onLoaded=function(t,e){this._valueStore._values=t,this._loaded=!0,e&&(this._valueStoreSerialization=e),this._handler&&this._handler._onStorageLoaded()},t.prototype._onError=function(t){this._handler&&this._handler._onStorageLoadError(t)},t}();e.StorageLoader=r;var o=function(){function t(){}return t.prototype.write=function(t,e,i){this._write&&this._write(t,e,i)},t.prototype.requestValuesForJoinPlayer=function(t){this._requestedKeysForJoinPlayer=t},t.prototype._createLoader=function(t,e){return new r(this,t,e)},t.prototype._registerWrite=function(t){this._write=t},t.prototype._registerLoad=function(t){this._load=t},t}();e.Storage=o}));e(Ft);Ft.Storage,Ft.StorageLoader,Ft.StorageValueStore,Ft.StorageCountsOperation,Ft.StorageCondition,Ft.StorageOrder,Ft.StorageRegion;var jt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.EventConverter=void 0;var i=function(){function t(t){var e;this._game=t.game,this._playerId=null!==(e=t.playerId)&&void 0!==e?e:null,this._playerTable={}}return t.prototype.toGameEvent=function(t){var e,i,r,o,n,s,a,h,c=t[0],l=t[1],d=t[2],u=this._playerTable[d]||{id:d};switch(c){case 0:u={id:d,name:t[3]},this._playerTable[d]&&null!=this._playerTable[d].userData&&(u.userData=this._playerTable[d].userData),this._playerTable[d]=u;var p=void 0;if(t[4]){var f=[],_=[];t[4].map((function(t){f.push(t.readKey),_.push(t.values)})),p=new Ft.StorageValueStore(f,_)}return new K.JoinEvent(u,p,l);case 1:return delete this._playerTable[u.id],new K.LeaveEvent(u,l);case 2:return h=t[3],new K.TimestampEvent(h,u,l);case 3:return u={id:d,name:t[3],userData:t[4]},this._playerTable[d]=u,new K.PlayerInfoEvent(u,l);case 32:return a=t[4],new K.MessageEvent(t[3],u,a,l);case 33:return a=t[7],e=t[3],r=null==(i=t[6])?void 0:i>=0?this._game.db[i]:this._game._localDb[i],o={x:t[4],y:t[5]},new tt.PointDownEvent(e,r,o,u,a,l);case 34:return a=t[11],e=t[3],r=null==(i=t[10])?void 0:i>=0?this._game.db[i]:this._game._localDb[i],o={x:t[4],y:t[5]},n={x:t[6],y:t[7]},s={x:t[8],y:t[9]},new tt.PointMoveEvent(e,r,o,s,n,u,a,l);case 35:return a=t[11],e=t[3],r=null==(i=t[10])?void 0:i>=0?this._game.db[i]:this._game._localDb[i],o={x:t[4],y:t[5]},n={x:t[6],y:t[7]},s={x:t[8],y:t[9]},new tt.PointUpEvent(e,r,o,s,n,u,a,l);case 64:a=t[5];var y=t[3],g=t[4],v=this._game._decodeOperationPluginOperation(y,g);return new K.OperationEvent(y,v,u,a,l);default:throw X.ExceptionFactory.createAssertionError("EventConverter#toGameEvent")}},t.prototype.toPlaylogEvent=function(t,e){var i,r,o,n,s,a,h,c,l;switch(t.type){case"join":case"leave":throw X.ExceptionFactory.createAssertionError("EventConverter#toPlaylogEvent: Invalid type: "+t.type);case"timestamp":var d=t;return l=e?null!==(i=d.player.id)&&void 0!==i?i:null:this._playerId,[2,d.eventFlags,l,d.timestamp];case"player-info":var u=t;return l=e?null!==(r=u.player.id)&&void 0!==r?r:null:this._playerId,[3,u.eventFlags,l,u.player.name,u.player.userData];case"point-down":var p=t;return c=p.target?p.target.id:null,l=e&&p.player?null!==(o=p.player.id)&&void 0!==o?o:null:this._playerId,[33,p.eventFlags,l,p.pointerId,p.point.x,p.point.y,c,!!p.local];case"point-move":var f=t;return c=f.target?f.target.id:null,l=e&&f.player?null!==(n=f.player.id)&&void 0!==n?n:null:this._playerId,[34,f.eventFlags,l,f.pointerId,f.point.x,f.point.y,f.startDelta.x,f.startDelta.y,f.prevDelta.x,f.prevDelta.y,c,!!f.local];case"point-up":var _=t;return c=_.target?_.target.id:null,l=e&&_.player?null!==(s=_.player.id)&&void 0!==s?s:null:this._playerId,[35,_.eventFlags,l,_.pointerId,_.point.x,_.point.y,_.startDelta.x,_.startDelta.y,_.prevDelta.x,_.prevDelta.y,c,!!_.local];case"message":var y=t;return l=e&&y.player?null!==(a=y.player.id)&&void 0!==a?a:null:this._playerId,[32,y.eventFlags,l,y.data,!!y.local];case"operation":var g=t;return l=e&&g.player?null!==(h=g.player.id)&&void 0!==h?h:null:this._playerId,[64,g.eventFlags,l,g.code,g.data,!!g.local];default:throw X.ExceptionFactory.createAssertionError("Unknown type: "+t.type)}},t.prototype.makePlaylogOperationEvent=function(t){var e=this._playerId;return[64,null!=t.priority?3&t.priority:0,e,t._code,t.data,!!t.local]},t}();e.EventConverter=i}));e(jt);jt.EventConverter;var It=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(It);var kt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(kt);var Rt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Rt);var Ut=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Ut);var Dt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Dt);var zt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(zt);var Bt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Bt);var Gt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.RequireCachedValue=void 0;var i=function(){function t(t){this._value=t}return t.prototype._cachedValue=function(){return this._value},t}();e.RequireCachedValue=i}));e(Gt);Gt.RequireCachedValue;var Wt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ScriptAssetContext=void 0;var i=function(){function t(t,e){this._asset=t,this._module=e,this._started=!1}return t.prototype._cachedValue=function(){if(!this._started)throw X.ExceptionFactory.createAssertionError("ScriptAssetContext#_cachedValue: not executed yet.");return this._module.exports},t.prototype._executeScript=function(t){return this._started||(t&&(this._module.parent=t,t.children.push(this._module)),this._started=!0,this._asset.execute(this._module._runtimeValue),this._module.loaded=!0),this._module.exports},t}();e.ScriptAssetContext=i}));e(Wt);Wt.ScriptAssetContext;var Nt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ModuleManager=void 0;var i=function(){function t(t,e){this._assetManager=e,this._runtimeValueBase=t,this._scriptCaches={}}return t.prototype._require=function(t,e){var i,r,o=this,n=this._assetManager._liveAssetVirtualPathTable,s=this._assetManager._moduleMainScripts;if(-1===t.indexOf("/")&&this._assetManager._assets.hasOwnProperty(t)&&(i=this._assetManager._assets[t],r=this._assetManager._liveAssetPathTable[i.path]),/^\.\/|^\.\.\/|^\//.test(t)){if(e){if(!e._virtualDirname)throw X.ExceptionFactory.createAssertionError("g._require: require from modules without virtualPath is not supported");r=H.PathUtil.resolvePath(e._virtualDirname,t)}else{if(!/^\.\//.test(t))throw X.ExceptionFactory.createAssertionError("g._require: entry point path must start with './'");r=t.substring(2)}if(this._scriptCaches.hasOwnProperty(r))return this._scriptCaches[r]._cachedValue();if(this._scriptCaches.hasOwnProperty(r+".js"))return this._scriptCaches[r+".js"]._cachedValue();i||(i=this._findAssetByPathAsFile(r,n)),i||(i=this._findAssetByPathAsDirectory(r,n))}else if(s[t]&&(i=n[r=s[t]]),!i){var a=e?e.paths:[];a.push("node_modules");for(var h=0;h<a.length;++h){var c=a[h];if(r=H.PathUtil.resolvePath(c,t),i=this._findAssetByPathAsFile(r,n))break;if(i=this._findAssetByPathAsDirectory(r,n))break}}if(i){if(this._scriptCaches.hasOwnProperty(r))return this._scriptCaches[r]._cachedValue();if("script"===i.type){var l=new V.Module({runtimeValueBase:this._runtimeValueBase,id:i.id,path:i.path,virtualPath:this._assetManager._liveAssetPathTable[i.path],requireFunc:function(t,e){return o._require(t,e)},resolveFunc:function(t,e){return o._resolvePath(t,e)}}),d=new Wt.ScriptAssetContext(i,l);return this._scriptCaches[r]=d,d._executeScript(e)}if("text"===i.type&&i&&".json"===H.PathUtil.resolveExtname(t))return(this._scriptCaches[r]=new Gt.RequireCachedValue(JSON.parse(i.data)))._cachedValue()}throw X.ExceptionFactory.createAssertionError("g._require: can not find module: "+t)},t.prototype._resolvePath=function(t,e){var i=null,r=this._assetManager._liveAssetVirtualPathTable,o=this._assetManager._moduleMainScripts;if(/^\.\/|^\.\.\/|^\//.test(t)){if(!e)throw X.ExceptionFactory.createAssertionError("g._require.resolve: couldn't resolve the moudle without currentModule");if(!e._virtualDirname)throw X.ExceptionFactory.createAssertionError("g._require.resolve: couldn't resolve the moudle path without virtualPath");if(i=H.PathUtil.resolvePath(e._virtualDirname,t),h=this._resolveAbsolutePathAsFile(i,r))return h;if(h=this._resolveAbsolutePathAsDirectory(i,r))return h}else{if(o[t])return o[t];var n=e?e.paths.concat():[];n.push("node_modules");for(var s=0;s<n.length;++s){var a=n[s],h=H.PathUtil.resolvePath(a,t);if(i=this._resolveAbsolutePathAsFile(h,r))return i;if(i=this._resolveAbsolutePathAsDirectory(h,r))return i}}throw X.ExceptionFactory.createAssertionError("g._require.resolve: couldn't resolve the path: "+t)},t.prototype._findAssetByPathAsFile=function(t,e){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t+".js")?e[t+".js"]:void 0},t.prototype._findAssetByPathAsDirectory=function(t,e){var i;if(i=t+"/package.json",e.hasOwnProperty(i)&&"text"===e[i].type){var r=JSON.parse(e[i].data);if(r&&"string"==typeof r.main){var o=this._findAssetByPathAsFile(H.PathUtil.resolvePath(t,r.main),e);if(o)return o}}if(i=t+"/index.js",e.hasOwnProperty(i))return e[i]},t.prototype._resolveAbsolutePathAsFile=function(t,e){return e.hasOwnProperty(t)?"/"+t:e.hasOwnProperty(t+".js")?"/"+t+".js":null},t.prototype._resolveAbsolutePathAsDirectory=function(t,e){var i=t+"/package.json";if(e.hasOwnProperty(i)&&"text"===e[i].type){var r=JSON.parse(e[i].data);if(r&&"string"==typeof r.main){var o=this._resolveAbsolutePathAsFile(H.PathUtil.resolvePath(t,r.main),e);if(o)return"/"+o}}return i=t+"/index.js",e.hasOwnProperty(i)?"/"+i:null},t}();e.ModuleManager=i}));e(Nt);Nt.ModuleManager;var Xt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NinePatchSurfaceEffector=void 0;var i=function(){function t(t,e){void 0===e&&(e=4),this.game=t,this.borderWidth="number"==typeof e?{top:e,bottom:e,left:e,right:e}:e}return t.prototype.render=function(t,e,i){return this._surface&&this._surface.width===e&&this._surface.height===i&&this._beforeSrcSurface===t||(this._surface=this.game.resourceFactory.createSurface(Math.ceil(e),Math.ceil(i)),this._beforeSrcSurface=t),rt.SurfaceUtil.drawNinePatch(this._surface,t,this.borderWidth),this._surface},t}();e.NinePatchSurfaceEffector=i}));e(Xt);Xt.NinePatchSurfaceEffector;var qt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(qt);var Ht=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Ht);var Vt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.OperationPluginManager=void 0;var i=function(){function t(t,e,i){this._code=t,this._handler=i,this._handlerOwner=e}return t.prototype.onOperation=function(t){var e;t instanceof Array?e={_code:this._code,data:t}:(e=t)._code=this._code,this._handler.call(this._handlerOwner,e)},t}(),r=function(){function t(t,e,i){this.onOperate=new n.Trigger,this.operated=this.onOperate,this.plugins={},this._game=t,this._viewInfo=e,this._infos=i,this._initialized=!1}return t.prototype.initialize=function(){this._initialized||(this._initialized=!0,this._loadOperationPlugins()),this._doAutoStart()},t.prototype.register=function(t,e,i){this._infos[e]={code:e,_plugin:this._instantiateOperationPlugin(t,e,i)}},t.prototype.start=function(t){var e=this._infos[t];e&&e._plugin&&e._plugin.start()},t.prototype.stop=function(t){var e=this._infos[t];e&&e._plugin&&e._plugin.stop()},t.prototype.destroy=function(){this.stopAll(),this.onOperate.destroy(),this.onOperate=void 0,this.operated=void 0,this.plugins=void 0,this._game=void 0,this._viewInfo=void 0,this._infos=void 0},t.prototype.stopAll=function(){if(this._initialized)for(var t=0;t<this._infos.length;++t){var e=this._infos[t];e._plugin&&e._plugin.stop()}},t.prototype._doAutoStart=function(){for(var t=0;t<this._infos.length;++t){var e=this._infos[t];!e.manualStart&&e._plugin&&e._plugin.start()}},t.prototype._loadOperationPlugins=function(){for(var t=0;t<this._infos.length;++t){var e=this._infos[t];if(e.script){var i=this._game._moduleManager._require(e.script);e._plugin=this._instantiateOperationPlugin(i,e.code,e.option)}}},t.prototype._instantiateOperationPlugin=function(t,e,r){if(t.isSupported()){if(this.plugins[e])throw new Error("Plugin#code conflicted for code: "+e);if(this._infos[e])throw new Error("this plugin (code: "+e+") is already defined in game.json");var o=new t(this._game,this._viewInfo,r);this.plugins[e]=o;var n=new i(e,this.onOperate,this.onOperate.fire);return o.operationTrigger.add(n.onOperation,n),o}},t}();e.OperationPluginManager=r}));e(Vt);Vt.OperationPluginManager;var Yt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Yt);var Jt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Jt);var Kt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Kt);var $t=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.PointEventResolver=void 0;var i=function(){function t(t){this._pointEventMap={},this._sourceResolver=t.sourceResolver,this._playerId=t.playerId}return t.prototype.pointDown=function(t){var e=this._sourceResolver.findPointSource(t.offset),i=e.point?e.point:t.offset,r=e.target?e.target.id:void 0,o=e.local;this._pointEventMap[t.identifier]={targetId:r,local:o,point:i,start:{x:t.offset.x,y:t.offset.y},prev:{x:t.offset.x,y:t.offset.y}};var n=[33,2,this._playerId,t.identifier,i.x,i.y,r];return e&&e.local&&n.push(e.local),n},t.prototype.pointMove=function(t){var e=this._pointEventMap[t.identifier];if(!e)return null;var i={x:0,y:0},r={x:0,y:0};this._pointMoveAndUp(e,t.offset,i,r);var o=[34,2,this._playerId,t.identifier,e.point.x,e.point.y,r.x,r.y,i.x,i.y,e.targetId];return e.local&&o.push(e.local),o},t.prototype.pointUp=function(t){var e=this._pointEventMap[t.identifier];if(!e)return null;var i={x:0,y:0},r={x:0,y:0};this._pointMoveAndUp(e,t.offset,i,r),delete this._pointEventMap[t.identifier];var o=[35,2,this._playerId,t.identifier,e.point.x,e.point.y,r.x,r.y,i.x,i.y,e.targetId];return e.local&&o.push(e.local),o},t.prototype._pointMoveAndUp=function(t,e,i,r){r.x=e.x-t.start.x,r.y=e.y-t.start.y,i.x=e.x-t.prev.x,i.y=e.y-t.prev.y,t.prev.x=e.x,t.prev.y=e.y},t}();e.PointEventResolver=i}));e($t);$t.PointEventResolver;var Zt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.RandomGenerator=void 0;var i=function(t){this.seed=t};e.RandomGenerator=i}));e(Zt);Zt.RandomGenerator;var Qt=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(Qt);var te=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(te);var ee=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SpriteFactory=void 0;var i=function(){function t(){}return t.createSpriteFromE=function(t,e,i){var r=e.x,o=e.y,n=0,s=0,a=e.width,h=e.height,c=e.calculateBoundingRect();if(!c)throw X.ExceptionFactory.createAssertionError("SpriteFactory.createSpriteFromE: camera must look e");a=c.right-c.left,h=c.bottom-c.top,c.left<e.x&&(n=e.x-c.left),c.top<e.y&&(s=e.y-c.top),e.moveTo(n,s),e._matrix&&(e._matrix._modified=!0);var l=t.game.resourceFactory.createSurface(Math.ceil(a),Math.ceil(h)),d=l.renderer();d.begin(),e.render(d,i),d.end();var u=new ot.Sprite({scene:t,src:l,width:a,height:h});return u.moveTo(c.left,c.top),e.moveTo(r,o),e._matrix&&(e._matrix._modified=!0),u},t.createSpriteFromScene=function(t,e,i){var r=t.game.resourceFactory.createSurface(Math.ceil(e.game.width),Math.ceil(e.game.height)),o=r.renderer();o.begin();for(var n=e.children,s=0;s<n.length;++s)n[s].render(o,i);return o.end(),new ot.Sprite({scene:t,src:r,width:e.game.width,height:e.game.height})},t}();e.SpriteFactory=i}));e(ee);ee.SpriteFactory;var ie=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(ie);var re=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(re);var oe=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(oe);var ne=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));e(ne);var se=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Xorshift=void 0;var i=function(){function t(t){this.initState(t)}return t.deserialize=function(e){var i=new t(0);return i._state0U=e._state0U,i._state0L=e._state0L,i._state1U=e._state1U,i._state1L=e._state1L,i},t.prototype.initState=function(t){var e=1812433253;t=e*(t^t>>30)+1,this._state0U=t,t=e*(t^t>>30)+2,this._state0L=t,t=e*(t^t>>30)+3,this._state1U=t,t=e*(t^t>>30)+4,this._state1L=t},t.prototype.randomInt=function(){var t=this._state0U,e=this._state0L,i=this._state1U,r=this._state1L;this._state0U=i,this._state0L=r;var o=0,n=0;o=(t^=o=t<<23|(-512&e)>>>9)^i,n=(e^=n=e<<23)^r;o^=t>>>17,n^=e>>>17|(131071&t)<<15;o^=i>>>26,n^=r>>>26|(67108863&i)<<6,this._state1U=o,this._state1L=n;var s=(n>>>0)+(r>>>0);return[o+i+(s/2>>>31)>>>0,s>>>0]},t.prototype.random=function(){var t=this.randomInt();return(4294967296*t[0]+t[1])/0x10000000000000000},t.prototype.nextInt=function(t,e){return Math.floor(t+this.random()*(e-t))},t.prototype.serialize=function(){return{_state0U:this._state0U,_state0L:this._state0L,_state1U:this._state1U,_state1L:this._state1L}},t}();e.Xorshift=i}));e(se);se.Xorshift;var ae=i((function(e,i){var r,o=t&&t.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});Object.defineProperty(i,"__esModule",{value:!0}),i.XorshiftRandomGenerator=void 0;var n=function(t){function e(e,i){var r=this;if(void 0===e)throw X.ExceptionFactory.createAssertionError("XorshiftRandomGenerator#constructor: seed is undefined");return(r=t.call(this,e)||this)._xorshift=i?se.Xorshift.deserialize(i):new se.Xorshift(e),r}return o(e,t),e.deserialize=function(t){return new e(t._seed,t._xorshift)},e.prototype.get=function(t,e){return this._xorshift.nextInt(t,e+1)},e.prototype.generate=function(){return this._xorshift.random()},e.prototype.serialize=function(){return{_seed:this.seed,_xorshift:this._xorshift.serialize()}},e}(Zt.RandomGenerator);i.XorshiftRandomGenerator=n}));e(ae);ae.XorshiftRandomGenerator;var he=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.Game=void 0;var i=function(){function t(t){var e=this._normalizeConfiguration(t.configuration);this.fps=e.fps,this.width=e.width,this.height=e.height,this.renderers=[],this.scenes=[],this.age=0,this.assetBase=t.assetBase||"",this.resourceFactory=t.resourceFactory,this.handlerSet=t.handlerSet,this.selfId=t.selfId,this.db=void 0,this.loadingScene=void 0,this.operationPlugins=void 0,this.random=void 0,this.localRandom=void 0,this._defaultLoadingScene=void 0,this._eventConverter=void 0,this._pointEventResolver=void 0,this._idx=void 0,this._localDb=void 0,this._localIdx=void 0,this._cameraIdx=void 0,this._isTerminated=void 0,this._modified=void 0,this._postTickTasks=void 0,this.playId=void 0,this.isSkipping=!1,this.joinedPlayerIds=[],this.audio=new ft.AudioSystemManager(this.resourceFactory),this.defaultAudioSystemId="sound",this.storage=new Ft.Storage,this.assets={},this.surfaceAtlasSet=new Tt.SurfaceAtlasSet({resourceFactory:this.resourceFactory}),this.onJoin=new n.Trigger,this.onLeave=new n.Trigger,this.onPlayerInfo=new n.Trigger,this.onSeed=new n.Trigger,this.join=this.onJoin,this.leave=this.onLeave,this.playerInfo=this.onPlayerInfo,this.seed=this.onSeed,this._eventTriggerMap={unknown:void 0,timestamp:void 0,join:this.onJoin,leave:this.onLeave,"player-info":this.onPlayerInfo,seed:this.onSeed,message:void 0,"point-down":void 0,"point-move":void 0,"point-up":void 0,operation:void 0},this.onResized=new n.Trigger,this.onSkipChange=new n.Trigger,this.resized=this.onResized,this.skippingChanged=this.onSkipChange,this.isLastTickLocal=!0,this.lastOmittedLocalTickCount=0,this.lastLocalTickMode=null,this.lastTickGenerationMode=null,this._onLoad=new n.Trigger,this._onStart=new n.Trigger,this._loaded=this._onLoad,this._started=this._onStart,this.isLoaded=!1,this.onSnapshotRequest=new n.Trigger,this.snapshotRequest=this.onSnapshotRequest,this.external={},this._runtimeValueBase=Object.create(t.engineModule,{game:{value:this,enumerable:!0}}),this._main=e.main,this._mainFunc=t.mainFunc,this._mainParameter=void 0,this._configuration=e,this._assetManager=new ut.AssetManager(this,e.assets,e.audio,e.moduleMainScripts),this._moduleManager=void 0;var i=e.operationPlugins||[];this.operationPluginManager=new Vt.OperationPluginManager(this,t.operationPluginViewInfo||null,i),this._onOperationPluginOperated=new n.Trigger,this._operationPluginOperated=this._onOperationPluginOperated,this.operationPluginManager.onOperate.add(this._onOperationPluginOperated.fire,this._onOperationPluginOperated),this.onSceneChange=new n.Trigger,this._onSceneChange=new n.Trigger,this._onSceneChange.add(this._handleSceneChanged,this),this._sceneChanged=this._onSceneChange,this._initialScene=new Pt.Scene({game:this,assetIds:this._assetManager.globalAssetIds(),local:!0,name:"akashic:initial-scene"}),this._initialScene.onLoad.add(this._handleInitialSceneLoad,this),this._reset({age:0})}return Object.defineProperty(t.prototype,"focusingCamera",{get:function(){return this._focusingCamera},set:function(t){t!==this._focusingCamera&&(this._modified&&this.render(),this._focusingCamera=t)},enumerable:!1,configurable:!0}),t.prototype.pushScene=function(t){this._postTickTasks.push({type:0,scene:t})},t.prototype.replaceScene=function(t,e){this._postTickTasks.push({type:1,scene:t,preserveCurrent:!!e})},t.prototype.popScene=function(t,e){void 0===e&&(e=1);for(var i=0;i<e;i++)this._postTickTasks.push({type:2,preserveCurrent:!!t})},t.prototype.scene=function(){if(this.scenes.length)return this.scenes[this.scenes.length-1]},t.prototype.tick=function(t,e,i){var r=null;if(this._isTerminated)return!1;if(this.isLastTickLocal=!t,this.lastOmittedLocalTickCount=e||0,this.scenes.length){if(r=this.scenes[this.scenes.length-1],i&&i.length)for(var o=0;o<i.length;++o){var n=this._eventConverter.toGameEvent(i[o]),s=this._eventTriggerMap[n.type];s&&s.fire(n)}r.onUpdate.fire(),t&&++this.age}return!!this._postTickTasks.length&&(this._flushPostTickTasks(),r!==this.scenes[this.scenes.length-1])},t.prototype.render=function(){if(this._modified){var t=this.scene();if(t){for(var e=this.focusingCamera,i=this.renderers,r=0;r<i.length;++r){var o=i[r];o.begin(),o.save(),o.clear(),e&&(o.save(),e._applyTransformToRenderer(o));for(var n=t.children,s=0;s<n.length;++s)n[s].render(o,e);e&&o.restore(),o.restore(),o.end()}this._modified=!1}}},t.prototype.resolvePointEvent=function(t){switch(t.type){case 0:return this._pointEventResolver.pointDown(t);case 1:return this._pointEventResolver.pointMove(t);case 2:return this._pointEventResolver.pointUp(t)}},t.prototype.findPointSource=function(t,e){e||(e=this.focusingCamera);var i=this.scene();if(i)return i.findPointSourceByPoint(t,!1,e)},t.prototype.register=function(t){if(t.local){if(void 0===t.id)t.id=--this._localIdx;else{if(t.id>0)throw X.ExceptionFactory.createAssertionError("Game#register: invalid local id: "+t.id);if(this._localDb.hasOwnProperty(String(t.id)))throw X.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+t.id);this._localIdx>t.id&&(this._localIdx=t.id)}this._localDb[t.id]=t}else{if(void 0===t.id)t.id=++this._idx;else{if(t.id<0)throw X.ExceptionFactory.createAssertionError("Game#register: invalid non-local id: "+t.id);if(this.db.hasOwnProperty(String(t.id)))throw X.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+t.id);this._idx<t.id&&(this._idx=t.id)}this.db[t.id]=t}},t.prototype.unregister=function(t){t.local?delete this._localDb[t.id]:delete this.db[t.id]},t.prototype.terminateGame=function(){this._isTerminated=!0,this._terminateGame()},t.prototype.modified=function(){this._modified=!0},t.prototype.raiseEvent=function(t){this.handlerSet.raiseEvent(this._eventConverter.toPlaylogEvent(t))},t.prototype.raiseTick=function(t){if(null!=t&&t.length){for(var e=[],i=0;i<t.length;i++)e.push(this._eventConverter.toPlaylogEvent(t[i]));this.handlerSet.raiseTick(e)}else this.handlerSet.raiseTick()},t.prototype.addEventFilter=function(t,e){this.handlerSet.addEventFilter(t,e)},t.prototype.removeEventFilter=function(t){this.handlerSet.removeEventFilter(t)},t.prototype.shouldSaveSnapshot=function(){return this.handlerSet.shouldSaveSnapshot()},t.prototype.saveSnapshot=function(t,e){this.handlerSet.saveSnapshot(this.age,t,this.random.serialize(),e)},t.prototype.getCurrentTime=function(){return this.handlerSet.getCurrentTime()},t.prototype.isActiveInstance=function(){return"active"===this.handlerSet.getInstanceType()},t.prototype._pushPostTickTask=function(t,e){this._postTickTasks.push({type:3,fun:t,owner:e})},t.prototype._normalizeConfiguration=function(t){if(!t)throw X.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: invalid arguments");if(null==t.assets&&(t.assets={}),null==t.fps&&(t.fps=30),"number"!=typeof t.fps)throw X.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be given as a number");if(!(0<=t.fps&&t.fps<=60))throw X.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be a number in (0, 60].");if("number"!=typeof t.width)throw X.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: width must be given as a number");if("number"!=typeof t.height)throw X.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: height must be given as a number");return t},t.prototype._setAudioPlaybackRate=function(t){this.audio._setPlaybackRate(t)},t.prototype._setMuted=function(t){this.audio._setMuted(t)},t.prototype._decodeOperationPluginOperation=function(t,e){var i=this.operationPluginManager.plugins[t];return i&&i.decode?i.decode(e):e},t.prototype._reset=function(t){if(this.operationPluginManager.stopAll(),this.scene()){for(;this.scene()!==this._initialScene;)this.popScene(),this._flushPostTickTasks();this.isLoaded||this.scenes.pop()}switch(t&&(void 0!==t.age&&(this.age=t.age),void 0!==t.randGenSer?this.random=ae.XorshiftRandomGenerator.deserialize(t.randGenSer):void 0!==t.randSeed&&(this.random=new ae.XorshiftRandomGenerator(t.randSeed))),this.audio._reset(),this._onLoad.removeAll({func:this._handleLoad,owner:this}),this.onJoin.removeAll(),this.onLeave.removeAll(),this.onSeed.removeAll(),this.onResized.removeAll(),this.onSkipChange.removeAll(),this.onSceneChange.removeAll(),this.handlerSet.removeAllEventFilters(),this.isSkipping=!1,this.onSkipChange.add(this._handleSkipChange,this),this.joinedPlayerIds=[],this.onJoin.add(this._handleJoinEvent,this),this.onLeave.add(this._handleLeaveEvent,this),this._idx=0,this._localIdx=0,this._cameraIdx=0,this.db={},this._localDb={},this._modified=!0,this.loadingScene=void 0,this._focusingCamera=void 0,this.lastLocalTickMode=null,this.lastTickGenerationMode=null,this.onSnapshotRequest.removeAll(),this._postTickTasks=[],this._eventConverter=new jt.EventConverter({game:this,playerId:this.selfId}),this._pointEventResolver=new $t.PointEventResolver({sourceResolver:this,playerId:this.selfId}),this.localRandom=new ae.XorshiftRandomGenerator(Math.floor(9007199254740991*Math.random())),this._isTerminated=!1,this.vars={},this._moduleManager=new Nt.ModuleManager(this._runtimeValueBase,this._assetManager),this.surfaceAtlasSet.destroy(),this.surfaceAtlasSet=new Tt.SurfaceAtlasSet({resourceFactory:this.resourceFactory}),this._configuration.defaultLoadingScene){case"none":this._defaultLoadingScene=new bt.LoadingScene({game:this});break;case"compact":this._defaultLoadingScene=new wt.DefaultLoadingScene({game:this,style:"compact"});break;default:this._defaultLoadingScene=new wt.DefaultLoadingScene({game:this})}},t.prototype._destroy=function(){if(this.operationPluginManager.destroy(),this.scene())for(;this.scene()!==this._initialScene;)this.popScene(),this._flushPostTickTasks();this._initialScene.destroy(),this.loadingScene&&!this.loadingScene.destroyed()&&this.loadingScene.destroy(),this._defaultLoadingScene.destroyed()||this._defaultLoadingScene.destroy(),this.db=void 0,this.renderers=void 0,this.scenes=void 0,this.random=void 0,this._modified=!1,this.age=0,this.assets=void 0,this.isLoaded=!1,this.loadingScene=void 0,this.assetBase="",this.selfId=void 0,this.audio.music.stopAll(),this.audio.sound.stopAll(),this.audio=void 0,this.defaultAudioSystemId=void 0,this.handlerSet=void 0,this.localRandom=void 0,this.onJoin.destroy(),this.onJoin=void 0,this.onLeave.destroy(),this.onLeave=void 0,this.onSeed.destroy(),this.onSeed=void 0,this.onPlayerInfo.destroy(),this.onPlayerInfo=void 0,this.onResized.destroy(),this.onResized=void 0,this.onSkipChange.destroy(),this.onSkipChange=void 0,this.onSceneChange.destroy(),this.onSceneChange=void 0,this.onSnapshotRequest.destroy(),this.onSnapshotRequest=void 0,this.join=void 0,this.leave=void 0,this.seed=void 0,this.playerInfo=void 0,this.snapshotRequest=void 0,this.resized=void 0,this.skippingChanged=void 0,this._sceneChanged=void 0,this._loaded=void 0,this._started=void 0,this._operationPluginOperated=void 0,this._onSceneChange.destroy(),this._onSceneChange=void 0,this._onLoad.destroy(),this._onLoad=void 0,this._onStart.destroy(),this._onStart=void 0,this.resourceFactory=void 0,this.storage=void 0,this.playId=void 0,this.operationPlugins=void 0,this._eventTriggerMap=void 0,this._initialScene=void 0,this._defaultLoadingScene=void 0,this._main=void 0,this._mainFunc=void 0,this._mainParameter=void 0,this._assetManager.destroy(),this._assetManager=void 0,this._eventConverter=void 0,this._pointEventResolver=void 0,this.operationPluginManager=void 0,this._onOperationPluginOperated.destroy(),this._onOperationPluginOperated=void 0,this._idx=0,this._localDb={},this._localIdx=0,this._cameraIdx=0,this._isTerminated=!0,this._focusingCamera=void 0,this._configuration=void 0,this._postTickTasks=[],this.surfaceAtlasSet.destroy(),this.surfaceAtlasSet=void 0,this._moduleManager=void 0},t.prototype._loadAndStart=function(t){this._mainParameter=t||{},this.isLoaded?this._handleLoad():(this._onLoad.add(this._handleLoad,this),this.pushScene(this._initialScene),this._flushPostTickTasks())},t.prototype._startLoadingGlobalAssets=function(){if(this.isLoaded)throw X.ExceptionFactory.createAssertionError("Game#_startLoadingGlobalAssets: already loaded.");this.pushScene(this._initialScene),this._flushPostTickTasks()},t.prototype._updateEventTriggers=function(t){if(this._modified=!0,!t)return this._eventTriggerMap.message=void 0,this._eventTriggerMap["point-down"]=void 0,this._eventTriggerMap["point-move"]=void 0,this._eventTriggerMap["point-up"]=void 0,void(this._eventTriggerMap.operation=void 0);this._eventTriggerMap.message=t.onMessage,this._eventTriggerMap["point-down"]=t.onPointDownCapture,this._eventTriggerMap["point-move"]=t.onPointMoveCapture,this._eventTriggerMap["point-up"]=t.onPointUpCapture,this._eventTriggerMap.operation=t.onOperation,t._activate()},t.prototype._handleInitialSceneLoad=function(){this._initialScene.onLoad.remove(this._handleInitialSceneLoad,this),this.assets=this._initialScene.assets,this.isLoaded=!0,this._onLoad.fire(this)},t.prototype._handleOperationPluginOperated=function(t){var e=this._eventConverter.makePlaylogOperationEvent(t);this.handlerSet.raiseEvent(e)},t.prototype._handleSceneChanged=function(t){this._updateEventTriggers(t);var e=t?t.local:"full-local",i=t?t.tickGenerationMode:"by-clock";this.lastLocalTickMode===e&&this.lastTickGenerationMode===i||(this.lastLocalTickMode=e,this.lastTickGenerationMode=i,this.handlerSet.changeSceneMode({local:e,tickGenerationMode:i}))},t.prototype._terminateGame=function(){},t.prototype._flushPostTickTasks=function(){do{var t=this._postTickTasks;this._postTickTasks=[];for(var e=0;e<t.length;++e){var i=t[e];switch(i.type){case 0:var r=this.scene();r&&r._deactivate(),this._doPushScene(i.scene);break;case 1:this._doPopScene(i.preserveCurrent,!1),this._doPushScene(i.scene);break;case 2:this._doPopScene(i.preserveCurrent,!0);break;case 3:i.fun.call(i.owner);break;default:throw X.ExceptionFactory.createAssertionError("Game#_flushPostTickTasks: unknown post-tick task type.")}}}while(this._postTickTasks.length>0)},t.prototype._handleSkipChange=function(t){this.isSkipping=t},t.prototype._handleJoinEvent=function(t){t.player.id&&-1===this.joinedPlayerIds.indexOf(t.player.id)&&this.joinedPlayerIds.push(t.player.id)},t.prototype._handleLeaveEvent=function(t){this.joinedPlayerIds=this.joinedPlayerIds.filter((function(e){return e!==t.player.id}))},t.prototype._doPopScene=function(t,e){var i=this.scenes.pop();if(!i)throw X.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; scene stack underflow");if(i===this._initialScene)throw X.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; attempting to pop the initial scene");if(t||i.destroy(),e){var r=this.scene();this.onSceneChange.fire(r),this._onSceneChange.fire(r)}},t.prototype._handleLoad=function(){if(this.operationPluginManager.initialize(),this.operationPlugins=this.operationPluginManager.plugins,this._mainFunc)this._mainFunc(this._runtimeValueBase,this._mainParameter||{});else{if(!this._main)throw X.ExceptionFactory.createAssertionError("Game#_handleLoad: does not have an entry point");var t=this._moduleManager._require(this._main);if(!t||"function"!=typeof t)throw X.ExceptionFactory.createAssertionError("Game#_handleLoad: Entry point "+this._main+" not found.");t(this._mainParameter)}this._flushPostTickTasks(),this._onStart.fire()},t.prototype._doPushScene=function(t,e){if(e||(e=this.loadingScene||this._defaultLoadingScene),this.scenes.push(t),t._needsLoading()&&"loaded-fired"!==t._loadingState){if(this._defaultLoadingScene._needsLoading())throw X.ExceptionFactory.createAssertionError("Game#_doPushScene: _defaultLoadingScene must not depend on any assets/storages.");this._doPushScene(e,this._defaultLoadingScene),e.reset(t)}else this.onSceneChange.fire(t),this._onSceneChange.fire(t),t._loaded||(t._load(),this._pushPostTickTask(t._fireLoaded,t));this._modified=!0},t}();e.Game=i}));e(he);he.Game;var ce=i((function(e,i){var r=t&&t.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),o=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||e.hasOwnProperty(i)||r(e,t,i)};Object.defineProperty(i,"__esModule",{value:!0}),o(n,i),o(N,i),Object.defineProperty(i,"AudioSystem",{enumerable:!0,get:function(){return q.AudioSystem}}),Object.defineProperty(i,"Module",{enumerable:!0,get:function(){return V.Module}}),Object.defineProperty(i,"ShaderProgram",{enumerable:!0,get:function(){return Y.ShaderProgram}}),Object.defineProperty(i,"VideoSystem",{enumerable:!0,get:function(){return J.VideoSystem}}),o(q,i),o(et,i),o(tt,i),o(it,i),o(nt,i),o(at,i),o(ht,i),o(ot,i),o(ct,i),o(lt,i),o(dt,i),o(ut,i),o(pt,i),o(ft,i),o(yt,i),o(gt,i),o(vt,i),o(mt,i),o(wt,i),o(Mt,i),o(Ct,i),o(Lt,i),o(K,i),o(jt,i),o(It,i),o(kt,i),o(Rt,i),o(Ut,i),o(X,i),o(_t,i),o(Dt,i),o(zt,i),o(bt,i),o(Bt,i),o($,i),o(V,i),o(Nt,i),o(Xt,i),o(Z,i),o(qt,i),o(Ht,i),o(Vt,i),o(Yt,i),o(Jt,i),o(H,i),o(Kt,i),o($t,i),o(Zt,i),o(Qt,i),o(te,i),o(Gt,i),o(Wt,i),o(Y,i),o(ee,i),o(Ft,i),o(Et,i),o(Tt,i),o(Ot,i),o(ie,i),o(rt,i),o(st,i),o(re,i),o(oe,i),o(ne,i),o(At,i),o(xt,i),o(Q,i),o(J,i),o(se,i),o(ae,i),o(Pt,i),o(he,i)}));e(ce);var le=i((function(t,e){Object.defineProperty(e,"__esModule",{value:!0})}));return e(le),e(i((function(e,i){var r=t&&t.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i),Object.defineProperty(t,r,{enumerable:!0,get:function(){return e[i]}})}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),o=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||e.hasOwnProperty(i)||r(e,t,i)};Object.defineProperty(i,"__esModule",{value:!0}),o(ce,i),o(le,i)})))}));
