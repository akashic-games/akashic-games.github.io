import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.f1c0562b.js";const h=JSON.parse('{"title":"ローカルエンティティを使う","description":"","frontmatter":{},"headers":[],"relativePath":"reverse-reference/v3/multiplay/local-entity.md","filePath":"reverse-reference/v3/multiplay/local-entity.md"}'),p={name:"reverse-reference/v3/multiplay/local-entity.md"},o=l(`<h1 id="ローカルエンティティを使う" tabindex="-1">ローカルエンティティを使う <a class="header-anchor" href="#ローカルエンティティを使う" aria-label="Permalink to &quot;ローカルエンティティを使う&quot;">​</a></h1><p>ローカルエンティティは、プレイヤーごとに異なる動作・異なる表示を行うことができるエンティティ (<code>g.E</code>) です。</p><h2 id="凡例" tabindex="-1">凡例 <a class="header-anchor" href="#凡例" aria-label="Permalink to &quot;凡例&quot;">​</a></h2><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">localSprite</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> g.</span><span style="color:#B392F0;">Sprite</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// その他プロパティ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ローカルであることを指定</span></span>
<span class="line"><span style="color:#E1E4E8;">  local: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// touchable: true を指定してクリック可能にしてもよい。</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// ただし受け取るイベントはローカルイベントになる(後述)</span></span>
<span class="line"><span style="color:#E1E4E8;">  touchable: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">localSprite</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> g.</span><span style="color:#6F42C1;">Sprite</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">...</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// その他プロパティ</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ローカルであることを指定</span></span>
<span class="line"><span style="color:#24292E;">  local: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// touchable: true を指定してクリック可能にしてもよい。</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// ただし受け取るイベントはローカルイベントになる(後述)</span></span>
<span class="line"><span style="color:#24292E;">  touchable: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">});</span></span></code></pre></div><h2 id="詳細" tabindex="-1">詳細 <a class="header-anchor" href="#詳細" aria-label="Permalink to &quot;詳細&quot;">​</a></h2><p>Akashic Engine のマルチプレイは、全プレイヤーの操作情報 (イベント) を全プレイヤーに共有し、それを全員が処理をすることで実現されます。 そのため原則的に全プレイヤーが同じフレームでは同じゲーム画面を表示します。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>参考: <a href="/tutorial/v3/multiplay/introduction.html#architecture-intro">Akashic Engine 入門 » Akashicにおけるマルチプレイ</a></p></div><p>しかしプレイヤーごとに異なる画面を表示したいことがあります。 例えば多人数の対戦ゲームで、各プレイヤーが装備を切り替える UI は、いちいち他プレイヤーの分まで表示すべきでないかもしれません。 このような時にローカルエンティティが利用できます。</p><p><strong>ローカルエンティティ</strong> は、マルチプレイでプレイヤーごとに異なる動作・異なる表示を行うことができるエンティティです。</p><p>ローカルエンティティは、エンティティのコンストラクタ引数の <code>local</code> プロパティに <code>true</code> を与えることで生成できます。</p><h3 id="touchable-なローカルエンティティ" tabindex="-1">touchable なローカルエンティティ <a class="header-anchor" href="#touchable-なローカルエンティティ" aria-label="Permalink to &quot;touchable なローカルエンティティ&quot;">​</a></h3><p>通常のエンティティ同様、ローカルエンティティは <code>touchable: true</code> を指定してクリック・タッチ可能にすることができます。</p><p>ただし <strong>ローカルエンティティに対するイベントは、「そのエンティティをクリック・タッチしたプレイヤー自身」にしか通知されません</strong> 。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 通常の (ローカルでない) エンティティ</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">sprite</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> g.</span><span style="color:#B392F0;">Sprite</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// その他プロパティ</span></span>
<span class="line"><span style="color:#E1E4E8;">  touchable: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">sprite.onPointDown.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">ev</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 誰かが \`sprite\` をクリック・タッチした時、</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 全プレイヤーの手元でここに書かれたコードが実行される</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ローカルエンティティ</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">localSprite</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> g.</span><span style="color:#B392F0;">Sprite</span><span style="color:#E1E4E8;">({</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// その他プロパティ</span></span>
<span class="line"><span style="color:#E1E4E8;">  local: </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;">, </span><span style="color:#6A737D;">// ローカルエンティティにする</span></span>
<span class="line"><span style="color:#E1E4E8;">  touchable: </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">localSprite.onPointDown.</span><span style="color:#B392F0;">add</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">ev</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// 誰かが \`localSprite\` をクリック・タッチした時、</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// クリックした本人のデバイスでのみ、ここに書かれたコードが実行される</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 通常の (ローカルでない) エンティティ</span></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">sprite</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> g.</span><span style="color:#6F42C1;">Sprite</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">...</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// その他プロパティ</span></span>
<span class="line"><span style="color:#24292E;">  touchable: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">sprite.onPointDown.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(</span><span style="color:#E36209;">ev</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 誰かが \`sprite\` をクリック・タッチした時、</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 全プレイヤーの手元でここに書かれたコードが実行される</span></span>
<span class="line"><span style="color:#24292E;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ローカルエンティティ</span></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">localSprite</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> g.</span><span style="color:#6F42C1;">Sprite</span><span style="color:#24292E;">({</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">...</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// その他プロパティ</span></span>
<span class="line"><span style="color:#24292E;">  local: </span><span style="color:#005CC5;">true</span><span style="color:#24292E;">, </span><span style="color:#6A737D;">// ローカルエンティティにする</span></span>
<span class="line"><span style="color:#24292E;">  touchable: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">localSprite.onPointDown.</span><span style="color:#6F42C1;">add</span><span style="color:#24292E;">(</span><span style="color:#E36209;">ev</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// 誰かが \`localSprite\` をクリック・タッチした時、</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// クリックした本人のデバイスでのみ、ここに書かれたコードが実行される</span></span>
<span class="line"><span style="color:#24292E;">});</span></span></code></pre></div><p>このような「発生させた本人にしか通知されないイベント」を、 <strong>ローカルイベント</strong> と呼びます。</p><p>ローカルイベントに起因する処理においては、ゲームのグローバルな実行状態を変更してはいけません。(後述)</p><p>ローカルイベントは操作した本人にのみ通知されますが、そこから改めて全プレイヤーに通知したいことがあります。 例えば「多人数の対戦ゲームの装備を切り替える UI で、実際に装備を変更した」時には、選んだ装備を全プレイヤーに通知しなければなりません。 この場合には <code>g.game.raiseEvent()</code> を使います。詳細は <a href="./notify-local-to-global.html">逆引きリファレンス » ローカルイベントからグローバルに通知する</a> を参照してください。</p><h3 id="ローカル処理とその制限" tabindex="-1">ローカル処理とその制限 <a class="header-anchor" href="#ローカル処理とその制限" aria-label="Permalink to &quot;ローカル処理とその制限&quot;">​</a></h3><p>ローカルイベントに起因して実行される処理など、特定のプレイヤーのデバイス上でしか行われない処理を <strong>ローカル処理</strong> と呼びます。</p><p>これは、主に <code>touchable</code> なローカルエンティティをクリック・タッチして、 <code>g.E#pointDown</code> などにイベントが通知された時の処理を指します。 ローカル処理中に呼び出された <code>g.Scene#setTimeout()</code> などが引き起こす処理もローカル処理に含みます。</p><p>ローカル処理には、そこでのみ許される処理や、逆に禁止される処理が存在します。</p><ul><li>ローカル処理で禁止される処理 <ul><li>ローカルでないエンティティの生成・操作</li><li>シーン遷移</li><li>(ローカル処理以外で利用している)乱数生成器(<code>g.Game#random</code> など)の利用</li></ul></li><li>ローカル処理で許される処理 <ul><li>ローカルエンティティの生成・操作</li><li><code>g.Game#focusingCamera</code> の変更 (次節で説明します)</li><li><code>Math.random()</code> の利用 (ローカル処理でのみ可能)</li><li>全体への通知 (<code>g.Game#raiseEvent()</code> の呼び出し) (ローカル処理でのみ可能)</li></ul></li></ul><p>ローカルイベントはそれを発生させたプレイヤーにとってしか存在しないので、ローカル処理では「プレイヤー間で間接的に共有されている実行状態」を破壊してはいけません。すなわち、同じ操作によって同じ実行状態が再現できなくなるような変更をしてはいけません。</p><p>例として、幅・高さが 100 で、 <code>touchable</code> が真である、ローカルでない矩形のエンティティを考えます。ローカル処理の中でこのエンティティの位置を原点から (200, 0) の位置に移動させたとします。するとそれ以降、たとえば (50, 50) の位置に対するポイント押下イベントの結果は、プレイヤー間によって異なるものになってしまいます。このようなエンティティ操作に限らず、ローカル処理では「非ローカルエンティティの生成」や「シーン遷移」「(ゲーム開発者が作った)ゲーム状態の変更」など、破壊的操作のほとんどを行ってはいけません。</p><p>通常の場合と異なり、Akashic Engine の乱数生成器 (<code>g.Game#random</code>) の利用も避けてください。ローカル処理によって特定のプレイヤーでのみ乱数生成が行われると、乱数生成器の内部状態が変わります。その結果、それ以降で各プレイヤーが乱数を生成した時に得られる数の系列が、一人だけ異なるものになってしまいます。ローカル処理で乱数を利用したい時は、 <code>g.game.localRandom</code> を利用してください。</p>`,25),e=[o];function c(t,r,E,i,y,d){return a(),n("div",null,e)}const g=s(p,[["render",c]]);export{h as __pageData,g as default};
