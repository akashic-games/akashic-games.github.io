<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-162208211-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-162208211-1');
</script>

<meta charset="UTF-8">
<meta name="viewport"    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="description" content="Akashic EngineはJavaScriptで動作する、無償利用が可能なマルチプラットフォーム対応ゲーム開発エンジンです">
<meta name="theme-color" content="#0F1F26">
<title>実際にマルチプレイゲームを考えて作ろう</title>
<link rel="icon"       href="/favicon.ico" type="image/vnd.microsoft.icon">
<link rel="stylesheet" href="/css/common.css?5ddd7a0">
<link rel="stylesheet" href="/css/header.css?5ddd7a0">
<link rel="stylesheet" href="/css/footer.css?5ddd7a0">


<link rel="stylesheet" href="/css/akashic-document.css?5ddd7a0">

<link rel="stylesheet" href="/css/railscasts.css?5ddd7a0">


<script src="/lib/jquery-3.2.1.min.js"></script>
<script src="/lib/common.js?5ddd7a0"></script>


<script src="/lib/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>

<div class="head--spacer"></div>
<div class="SP--head--menu--show"></div>
<div class="SP--head--menu--hide"></div>

<div class="head--menu--outer">
	<ul class="head--menu">
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/tutorial/v3/">Akashic Engine入門</a></li>
				<li><a href="/shin-ichiba/">ニコ生ゲームを作ろう</a></li>
				<!--li><a href="/tutorial/akashic-info.html">Akashic Engine関連情報一覧</a></li-->
			</ul>
		</li>
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/guide/akashic-cli.html">akashic-cli利用ガイド</a></li>
				<li><a href="/guide/game-json.html">game.jsonの仕様</a></li>
				<li><a href="/guide/asset-recommended-spec.html">素材の推奨仕様</a></li>
				<li><a href="/guide/composite-operation.html">CompositeOperationの利用</a></li>
				<li><a href="/guide/storage.html">ストレージについて</a></li>
				<li><a href="/guide/asset-load-error.html">アセットロードエラーについて</a></li>
				<li><a href="/guide/atsumaru.html">RPGアツマール投稿ガイド</a></li>
				<li><a href="/guide/template-guide.html">akashic initテンプレート利用ガイド</a></li>
				<li><a href="/guide/shader.html">シェーダの利用</a></li>
				<li><a href="/guide/shin-ichiba/index.html">ニコニコ生放送で遊べるゲームの作成</a></li>
				<li><a href="/guide/sandbox-config.html">sandbox.config.jsの仕様</a></li>
				<li><a href="/guide/bmpfont-generator.html">bmpfont-generator の仕様</a></li>
				<li><a href="/guide/common-pitfalls.html">よくある落とし穴</a></li>
			</ul>
		</li>
		<li class="head--menu--item"><a class="head--logo" href="/" title="ホーム"></a></li>
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/reference/akashic-engine-v3/globals.html">akashic-engine v3.x</a></li>
				<li><a href="/reference/akashic-timeline/">akashic-timeline</a></li>
				<li><a href="/reference/akashic-animation/">akashic-animation</a></li>
				<li><a href="/reference/akashic-label/">akashic-label</a></li>
				<li><a href="/reference/akashic-tile/">akashic-tile</a></li>
				<li><a href="/reference/akashic-box2d/">akashic-box2d</a></li>
				<li><a href="/reference/coe/">coe framework</a></li>
				<li><a href="/reference/raycaster-js/">raycaster-js</a></li>
				<li><a href="/reference/collision-js/">collision-js</a></li>
				<li><a href="/reference/akashic-engine-v2/modules/_lib_main_d_.g.html">akashic-engine v2.x (旧版)</a></li>
				<li><a href="/reference/akashic-engine-v1/modules/_lib_main_d_.g.html">akashic-engine v1.x (旧版)</a></li>
			</ul>
		</li>
		<li class="head--menu--item">
			<p class="head--menu--item--tab"></p>
			<ul class="head--menu--item--list">
				<li><a href="/demo/?title=helloworld">Hello World</a></li>
				<li><a href="/demo/?title=scale-rotate-opacity">拡縮・回転・透明度</a></li>
				<li><a href="/demo/?title=bitmap-font">ビットマップフォント</a></li>
				<li><a href="/demo/?title=framesprite">フレームアニメーション</a></li>
				<li><a href="/demo/?title=demo-touchevent">タッチイベント</a></li>
				<li><a href="/demo/?title=demo-tile">タイル</a></li>
				<li><a href="/demo/?title=label-sample">ラベル</a></li>
				<li><a href="/demo/?title=animation-showcase">アニメーション制御</a></li>
				<li><a href="/demo/?title=timeline-sample">トゥイーン制御</a></li>
				<li><a href="/demo/?title=simpleShot">アブストラクトシューティング</a></li>
				<li><a href="/demo/?title=HoppingWitch">HOPPING WITCH</a></li>
				<li><a href="/demo/?title=GalaxyWars">GALAXY WARS</a></li>
				<li><a href="/demo/?title=cannontv">いくぜ！ 超会議</a></li>
				<li><a href="/asset/material.html">サンプルデモの素材</a></li>
			</ul>
		</li>
	</ul>
</div>

<header id="akashic-page-header">
	<div class="SP--head--logo--box"><a class="head--logo" href="/" title="ホーム"></a></div>
</header>

<div id="BodyInner">
	<section class="akashic--document safearea--LR twocol">
		<div class="twocol-side">
			<h3>ニコ生ゲームを作ろう</h3>
<ul>
<li><strong><a href="./index.html">トップ</a></strong></li>
<li><strong><a href="./introduction.html">ニコ生ゲームとは</a></strong></li>
<li><strong><a href="./mod-game.html">ニコ生ゲームを作ろう・改造編</a></strong><ul>
<li><a href="./install.html">インストール</a></li>
<li><a href="./thiefBuster-mod.html">『泥棒バスター』を改造する</a></li>
<li><a href="./speed-jigsaw-mod.html">『スピードジグソー』を改造する</a></li>
</ul>
</li>
<li><strong><a href="./ranking-top.html">ニコ生ゲームを作ろう・ランキングゲーム編</a></strong><ul>
<li><a href="./ranking.html">ランキング対応ゲーム</a></li>
<li><a href="./ranking-by-template.html">テンプレートでわかるランキング対応ゲーム</a></li>
</ul>
</li>
<li><strong><a href="./multi-top.html">ニコ生ゲームを作ろう・マルチプレイゲーム編</a></strong><ul>
<li><a href="./multi-ready.html">マルチプレイ開発予備知識</a></li>
<li><a href="./column-about-multi.html">マルチプレイゲームを知ろう</a></li>
<li><a href="./column-local-process.html">簡単なゲームを作ってローカル処理に触れよう</a></li>
<li><a href="./column-join-leave.html">Join と Leave とニコ生の話</a></li>
<li><a href="./column-make-multi.html">実際にマルチプレイゲームを考えて作ろう</a></li>
</ul>
</li>
<li><strong><a href="./submit.html">ニコ生ゲームを投稿しよう</a></strong></li>
<li><strong><a href="./play.html">ニコ生ゲームで遊ぼう</a></strong></li>
<li><strong><a href="./design-guidelines.html">デザインガイドライン</a></strong></li>
<li><strong><a href="./links.html">関連資料・困った時は</a></strong></li>
</ul>

		</div>
		<div class="twocol-main">
			<div class="inner responsive--width--twocol">
				<h1>実際にマルチプレイゲームを考えて作ろう</h1>
<p>前ページまでで、Akashic Engine + マルチプレイ なゲームを作るための大雑把な知識を導入し終わりました。
最後に、いままでのおさらいや考え方を軽く流した後に、こちらで用意したサンプルゲームの紹介をしていこうと思います。</p>
<h2>いままでのまとめ</h2>
<p><strong>今までの連載を１項目につき一行で</strong>おさらいします。</p>
<ul>
<li>マルチプレイゲームとはどういうものか<ul>
<li>他人が同じ世界に存在し、共有物やお互いに干渉しあうゲーム</li>
</ul>
</li>
<li>他人と自分で違う状態を持つ方法<ul>
<li>ローカル処理によって<strong>自分の PC だけで発生する処理</strong>、を記述できます</li>
</ul>
</li>
<li>自分の操作を他人へ伝える方法<ul>
<li>raiseEvent によって、<strong>任意の情報を全員に送信</strong>することができます</li>
</ul>
</li>
<li>ニコ生上で動作させるための tips<ul>
<li>ゲーム起動直後の Join 処理によって、<strong>放送者を識別</strong>することができます</li>
</ul>
</li>
</ul>
<p>かなりの超特急にも感じますが、仕組みの解説は殆ど終わっています。
今回紹介するサンプルゲームも、今まで連載に出て来た以上のことはしていません。</p>
<h2>実際にゲーム作る</h2>
<p>実際のゲームの中身は皆さんに考えていただくとして、以上の知識があれば理論上はマルチプレイゲームが作れます。
したがって以下では、技術の話というよりはサンプルゲームを紹介しつつ、どのような流れで作り、何を気をつけたか、といった<strong>大まかな流れの部分</strong>を説明していこうと思います。</p>
<h3>ゲームを考えた</h3>
<p>一番最初の記事に遡って、どんなゲームを作るか考えます。こういう時のコツは、目標や条件など定義して<strong>自らに制約を課す</strong>ことです。
今回は以下の制約を設定しました。</p>
<ul>
<li>ニコ生上で投稿ゲームとして動作させること（運営だけが使える機能みたいなのは使わない）</li>
<li>PC、スマホ両方で遊べること<ul>
<li>スマホ対応、という点からキーボードとマウスに依存しないこと</li>
<li>PC 対応、という点からマルチタッチに依存しないこと</li>
<li>以上より、指一本で遊べ、精密なタッチを要求しないこと<ul>
<li>小さいマス目を正確にタッチする、みたいなのはスマホではキツイ</li>
<li>綺麗な直線を素早く書く、みたいなのはマウスではキツイ</li>
</ul>
</li>
</ul>
</li>
<li>放送者を含む参加者全員のガチンコ勝負で、最後に一人だけ勝者が決まること</li>
<li>画面上に他人が存在すること</li>
<li>複雑なルールを要求しないこと</li>
</ul>
<p>こんな感じで設定しました。
最近のニコ生ではタワーが流行っています。少し前はつりっくまやだるまさんがホットでしたね。
タワーは協力ゲーム、だるまさんは放送者 vs 他全員、つりっくまは個人戦だけど他人の様子がよくわからない、という特徴を持っていました。
今回はそれのいずれとも性質の異なるゲームを作りたくて前述の制約となりました。</p>
<h2>JumperGame</h2>
<p>岩を避けながらジャンプし、少しずつ右へ進んでいくゲームを作りました。
最大３０人まで参加することができます。見た目はなんともですが</p>
<ul>
<li>放送者をゲームマスターとした参加、募集締め切り</li>
<li>参加者全員で同期したゲーム進行</li>
<li>自分のジャンプを全員に通知し同期させる</li>
</ul>
<p>といった、マルチプレイゲームに必要な要素はだいたい入っていると思います。</p>
<p>ソースコード一式は以下で入手できます。
<a href="https://github.com/akashic-contents/jumper-game">https://github.com/akashic-contents/jumper-game</a></p>
<h3>ゲームの流れ</h3>
<ol>
<li>ゲームが起動されると誰かの join を一回だけ待つ</li>
<li>join して来た人をゲームマスターとして設定</li>
<li>タイトル画面で参加者待ち受け開始</li>
<li>ゲームマスターが適当なタイミングでゲーム開始</li>
<li>ゲーム画面で遊ぶ</li>
<li>終了条件を満たしたら終わり</li>
<li>3 に戻る</li>
</ol>
<p>これを繰り返します。以下で個別に解説していきます。ゲームマスターや Join については第３回の記事が理解に役立つでしょう。</p>
<h3>ゲームマスターの Join 待ち</h3>
<p>ゲーム起動直後のコードがこんな感じです。</p>
<pre><code class="language-ts">function onJoin(e) {
  // e.player.idを使って初期化処理
}

g.game.join.addOnce(e =&gt; {
  onJoin(e);
});

// joinを待ち受ける仮のシーン
const dummyScene = new g.Scene({ game: g.game });
dummyScene.update.add(() =&gt; {});

g.game.pushScene(new g.Scene({ game: g.game }));</code></pre>
<p>Akashic Engine の仕組み上での Join を待ちます。ニコ生ではゲーム起動時に放送者のみが Join する、という仕組みになっていますので実際にはほぼ一瞬かと思います。</p>
<h3>タイトル画面</h3>
<p>タイトル画面の中身は解説記事第三回の中身ほぼそのままです。
ボタンを二つ初期化し、ゲームマスターには参加締め切りボタン、それ以外の人には参加ボタンを表示しています。</p>
<div style="display:flex; flex-flow:row nowrap">
    <img src="/img/shin-ichiba/multi/04-01.png" width="300">
    <img src="/img/shin-ichiba/multi/04-02.png" width="300">
</div>

<p>それぞれのボタンはローカルエンティティとなっていて</p>
<ul>
<li>開始ボタン：close メッセージを全員に送り、募集を終了する</li>
<li>参加ボタン：join メッセージを送り、募集に参加する</li>
</ul>
<p>という機能を持ちます。ここでいう join は Akashic Engine の Join とは関係ない、このゲーム独自の処理です。</p>
<h3>ゲーム画面</h3>
<img src="/img/shin-ichiba/multi/04-03.png" width="600">

<p>ゲームが開始されると、もし参加していればボタンが二つ表示され、自分のキャラ（Jumper）が赤くハイライトされます。
ここで重要なのは、<strong>何がローカルで何がグローバルなのか</strong>を考えることです。
Akashic Engine では特筆しない限りグローバルとなるので、この画面に存在するもののほとんどはグローバルであり、ローカルなものを抽出したほうが早いでしょう。</p>
<p>と言いつつ、ローカルなものは殆どありません。
敵の配置やラウンド進行、残り人数や順位といった、<strong>ほぼ全ての情報は同期してほしい</strong>ためグローバルになっています。
ローカルな分岐で破壊しないことに気をつけて書くだけで、全ての操作が同期するのは結構すごいことです。Akashic Engine の強みです。</p>
<p>一応以下に、意識してローカルエンティティを書いた部分をあげておきます。</p>
<h3>今回のゲームでローカルなもの</h3>
<h4>ボタン</h4>
<p>まず、左下と右下にあるボタンは操作用のもので、これを押すと Jumper がジャンプしたり、挨拶したりします。
自分がジャンプボタンを押した時、<strong>自分の Jumper だけがジャンプしなければなりません。</strong></p>
<p>これを実現する方法は二つあります。</p>
<ol>
<li>ボタンが押された時の処理で誰が押したかを判定し、そのキャラだけをジャンプさせる</li>
<li>ボタンをローカルエンティティとして作り、メッセージを送信してそのメッセージでジャンプさせる</li>
</ol>
<p>どちらでも実現できます。1 のほうが処理が簡単なのですが追加条件として</p>
<p>a. ジャンプした後はしばらくボタンが押せない
b. ジャンプできない場合、ボタンがグレーになる</p>
<p>をつけると話が変わってきます。a だけであればまだ 1 でも大丈夫でしたが、ボタンそのものの状態を各々変えるにはボタンをローカルエンティティにする必要があります。
そうするとボタンが押された時の処理にはグローバルなものが書けないため、2 の手法を取る必要があります。挨拶ボタンに関しても同様です。</p>
<h4>Jumper</h4>
<p>Jumper の画像もローカルエンティティです。
Jumper の位置、生死、ジャンプしているかどうかなどといった情報は全てグローバルなものですが、<strong>自分の Jumper は強調表示されてほしい</strong>ため、Sprite はローカルエンティティで作ります。</p>
<h2>制作を進めていく上での注意点</h2>
<h3>raiseEvent の取り扱い</h3>
<p>実際にゲームを作っていくとすぐにわかることなのですが、<strong>raiseEvent を使わなければならないシーンはかなり少ない</strong>です。
<strong>状態は何もしなくても他人と同期する</strong>という Akashic Engine の特徴があるためです。
同期していないもの、つまり<strong>他人が知り得ない情報が同期状態にあるものに影響を及ぼすとき</strong>初めて、raiseEvent の出番になります。
大体において、これは誰かがローカルなエンティティを操作した時が該当します。
<strong>自分だけの操作は他の人は知り得ない</strong>ので、操作した結果を通知する必要があるわけですね。</p>
<h2>まとめ</h2>
<p>今回は今までのおさらいを軽くしつつ、いままでのまとめとして作ったマルチプレイゲームを掲載しました。
マルチプレイゲームの作成に基本的な知識は解説し終わりましたので、ここで一旦この記事は一区切りとなります。
ニコ生上でマルチプレイゲームを作るという試みは一見荒唐無稽ですが、ニコ生での新しい遊び方の一つとして今後も進めていきたいと考えています。
現時点でも、ニコ生上でゲームを動作させると以下のようなメリットがあります。</p>
<ul>
<li>サーバーを用意せず公開できる（生放送にきてもらう必要がありますが）</li>
<li>ログイン機構がいらない（ニコニコにログインしないとゲームが操作できない）</li>
<li>タイムシフトに対応する（Akashic Engine の機能でプレー内容が保存される）</li>
</ul>
<p>まだまだ機能が少なかったり、解説できていない機能もあったりしますが、この記事が少しでもニコ生ゲーム投稿の助けになれば幸いです。</p>
<div class="navi-center">
<a href="./column-join-leave.html">前 (JoinとLeaveとニコ生の話)</a>
 | <a href="./index.html">目次</a>
 | <a href="./submit.html">次 (ニコ生ゲームを投稿しよう)</a>
</div>

			</div>
		</div>
	</section>
	<footer class="safearea--LR">
	<div class="responsive--width">

		<ul class="foot--creativecommons">
			<li class="foot--creativecommons--ban"><a href="http://creativecommons.org/licenses/by/2.1/jp/" target="_blank"><img alt="クリエイティブ・コモンズ・ライセンス" src="https://i.creativecommons.org/l/by/2.1/jp/80x15.png"></a></li>
			<li class="foot--creativecommons--txt">このサイトの画像は、一部を除き <a rel="license" href="http://creativecommons.org/licenses/by/2.1/jp/" target="_blank">クリエイティブ・コモンズ 表示 2.1 日本 ライセンス</a><br>の下に提供されています: <a href="/image-license.html">詳細</a></li>
		</ul>

		<ul class="foot--license">
			<li class="foot--license--akashic"><a href="https://akashic-games.github.io"></a></li>
			<li class="foot--license--dwango"><a href="http://dwango.co.jp" target="_blank">&copy; dwango</a></li>
		</ul>

	</div>
</footer>

</div>
<div class="page--top"></div>
<div class="window--dark"></div>

<script>
	// リサイズ時にコンテンツのリサイズができない状態なので暫定対応でコンテンツをリロードしている
	// TODO: リサイズ時にコンテンツも追従する仕組みを作成する
	window.addEventListener('resize', function() {
		var iframes = document.getElementsByClassName('akashic-content');
		var contents = Array.prototype.slice.call(iframes);
		contents.forEach(function(content) {
			content.contentWindow.location.reload(true);
		});
	});
</script>
</body>
</html>
