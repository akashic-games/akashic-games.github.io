async function e(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),i=document.createElement("img");i.src=a,i.onload=function(){URL.revokeObjectURL(a),t({width:i.width,height:i.height})},i.onerror=function(e){n(e)}})}async function t(e){return t([],"",e);async function t(e,n,a){if(!a)return e;if(a.isDirectory){let i=a.createReader();return new Promise((r,o)=>{!function l(){i.readEntries(async i=>{if(!i||0===i.length){r(e);return}for(let r of i)await t(e,`${n}/${a.name}`,r);l()},o)}()})}return a.isFile?new Promise((t,i)=>{a.file(i=>{e.push({file:i,path:`${n}/${a.name}`.normalize()}),t(e)},i)}):e}}async function n(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),i=new Audio;i.src=a,i.load(),i.addEventListener("loadedmetadata",function(e){URL.revokeObjectURL(a),t(Math.ceil(1e3*i.duration))}),i.onerror=function(e){URL.revokeObjectURL(a),n(e)}})}async function a(a){let i=await t(a);!function(e){if(0===e.length)return;let t=e.filter(e=>/\/game.json$/.test(e.path));if(0===t.length)throw Error("Wrong input: No game.json found.");if(t.length>1)throw Error("Wrong input: Found multiple game.json.");let n=t[0].path.replace(/game.json$/,""),a=RegExp("^"+n);e.forEach(e=>{e.path=e.path.replace(a,"")})}(i);let r={},o={};for(let{file:t,path:a}of i)if(!/\/\.gitkeep$/.test(a)){if(/^(image|assets)\//.test(a)&&("image/png"===t.type||"image/png"===t.type)){let n=await e(t),i={type:"image",path:a,width:n.width,height:n.height,hint:{untainted:!0}};r[i.path]=i}else if(/^(audio|assets)\/.*\.(?:ogg|aac|m4a|mp4)$/.test(a)){let e;let i=a.split(".").pop(),l=a.replace(/\.(ogg|aac|m4a|mp4)$/,"");if(r[l]){if("ogg"!==o[l].ext){e=await n(t);let a=r[l];("ogg"===i||a.duration<e)&&(a.duration=e,o[l]={ext:i,duration:e})}continue}e=await n(t);let s=/\/(?:se|me)\//.test(a),c={type:"audio",path:l,duration:e,systemId:s?"sound":"music",global:!0};r[c.path]=c,o[l]={ext:i,duration:e}}else if(/^text\//.test(a)){let e={type:"text",path:a,global:!0},t=e.path.replace(/^.*\//,"").replace(/\.[^\.]+$/,"");r[t]=e}}let l=JSON.parse(await i.find(e=>"game.json"===e.path).file.text()),s=JSON.parse(await i.find(e=>"text/Plugins.json"===e.path)?.file.text()??"[]"),c=null,d=null;for(let e of s)if(e.status)switch(e.name){case"Community_Basic":c=e.parameters;break;case"AkashicRankingMode":d=e.parameters}return{...l,width:c?Number(c.screenWidth):l.width,height:c?Number(c.screenHeight):l.height,assets:{...l.assets,...r},environment:{...l.environment,nicolive:{...l.environment?.nicolive,preferredSessionParameters:{totalTimeLimit:d?Number(d.totalTimeLimit):75}},external:{send:"0"},"akashic-runtime":{version:"~3.7.3-0",flavor:"-canvas"}}}}window.addEventListener("load",()=>{let e=document.getElementById("drop_zone"),t=document.getElementById("result"),n=document.getElementById("download"),i=null;e.addEventListener("drop",async e=>{if(e.preventDefault(),!e.dataTransfer?.items?.length)return;let r=e.dataTransfer.items[0].webkitGetAsEntry();r&&(i=await a(r),t.innerHTML=JSON.stringify(i,null,2).replace(/\n/g,"<br>"),n.disabled=!1)}),e.addEventListener("dragover",e=>e.preventDefault()),n.addEventListener("click",()=>{let e=JSON.stringify(i,null,2),t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.target="_blank",a.download="game.json",a.click(),URL.revokeObjectURL(n)})});