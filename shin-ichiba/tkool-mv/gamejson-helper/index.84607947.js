async function e(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),i=document.createElement("img");i.src=a,i.onload=function(){URL.revokeObjectURL(a),t({width:i.width,height:i.height})},i.onerror=function(e){n(e)}})}class t extends Error{}async function n(e){return t([],"",e);async function t(e,n,a){if(!a)return e;if(a.isDirectory){let i=a.createReader();return new Promise((r,s)=>{!function o(){i.readEntries(async i=>{if(!i||0===i.length){r(e);return}for(let r of i)await t(e,`${n}/${a.name}`,r);o()},s)}()})}return a.isFile?new Promise((t,i)=>{a.file(i=>{e.push({file:i,path:`${n}/${a.name}`.normalize()}),t(e)},i)}):e}}async function a(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),i=new Audio;i.src=a,i.load(),i.addEventListener("loadedmetadata",function(e){URL.revokeObjectURL(a),t(Math.ceil(1e3*i.duration))}),i.onerror=function(e){URL.revokeObjectURL(a),n(e)}})}async function i(i){let r=await n(i);!function(e){if(0===e.length)return;let n=e.filter(e=>/\/game.json$/.test(e.path));if(0===n.length)throw new t("ドラッグ＆ドロップされたフォルダに game.json が存在しません。");if(n.length>1)throw new t("ドラッグ＆ドロップされたフォルダに game.json が複数存在します。game.json は1ファイルのみ必要です。");let a=n[0].path.replace(/game.json$/,""),i=RegExp("^"+a);e.forEach(e=>{e.path=e.path.replace(i,"")})}(r);let s={},o={},l={};for(let{file:t,path:n}of r)if(!/\/\.gitkeep$/.test(n)){if(/^(image|assets)\//.test(n)&&("image/png"===t.type||"image/png"===t.type)){let a=await e(t),i={type:"image",path:n,width:a.width,height:a.height,hint:{untainted:!0}};s[i.path]=i}else if(/^(audio|assets)\/.*\.(?:ogg|aac|m4a|mp4)$/.test(n)){let e;let i=n.split(".").pop(),r=n.replace(/\.(ogg|aac|m4a|mp4)$/,"");l[r]||(l[r]=new Set),l[r].add(`.${i}`);let c=Array.from(l[r]);if(s[r]){let n=s[r];n.hint={extensions:c},"ogg"!==o[r].ext&&(e=await a(t),("ogg"===i||n.duration<e)&&(n.duration=e,o[r]={ext:i,duration:e}));continue}e=await a(t);let d=/\/(?:se|me)\//.test(n),m={type:"audio",path:r,duration:e,systemId:d?"sound":"music",global:!0,hint:{extensions:c}};s[m.path]=m,o[r]={ext:i,duration:e}}else if(/^text\//.test(n)){let e={type:"text",path:n,global:!0},t=e.path.replace(/^.*\//,"").replace(/\.[^\.]+$/,"");s[t]=e}}let c=JSON.parse(await r.find(e=>"game.json"===e.path).file.text()),d=JSON.parse(await r.find(e=>"text/Plugins.json"===e.path)?.file.text()??"[]"),m=null,u=null;for(let e of d)if(e.status)switch(e.name){case"Community_Basic":m=e.parameters;break;case"AkashicRankingMode":u=e.parameters}return{...c,width:m?Number(m.screenWidth):c.width,height:m?Number(m.screenHeight):c.height,assets:{...c.assets,...s},environment:{...c.environment,nicolive:{...c.environment?.nicolive,preferredSessionParameters:{totalTimeLimit:u?Number(u.totalTimeLimit):75}},external:{send:"0"},"akashic-runtime":{version:"~3.7.3-0",flavor:"-canvas"}}}}window.addEventListener("load",()=>{let e=document.getElementById("drop_zone"),n=document.getElementById("result"),a=document.getElementById("download"),r=document.getElementById("message_area"),s=null;e.addEventListener("drop",async e=>{if(e.preventDefault(),!e.dataTransfer?.items?.length)return;r.innerHTML="";let o=e.dataTransfer.items[0].webkitGetAsEntry();if(o){if(o.isFile){r.innerHTML="game.json を含むフォルダをドラッグ＆ドロップしてください。";return}try{s=await i(o),n.innerHTML=JSON.stringify(s,null,2).replace(/\n/g,"<br>"),a.disabled=!1}catch(e){e instanceof t&&(r.innerHTML=e.message)}}}),e.addEventListener("dragover",e=>e.preventDefault()),a.addEventListener("click",()=>{let e=JSON.stringify(s,null,2),t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.target="_blank",a.download="game.json",a.click(),URL.revokeObjectURL(n)})});