async function e(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),i=document.createElement("img");i.src=a,i.onload=function(){URL.revokeObjectURL(a),t({width:i.width,height:i.height})},i.onerror=function(e){n(e)}})}class t extends Error{}async function n(e){return t([],"",e);async function t(e,n,a){if(!a)return e;if(a.isDirectory){let i=a.createReader();return new Promise((r,o)=>{!function s(){i.readEntries(async i=>{if(!i||0===i.length){r(e);return}for(let r of i)await t(e,`${n}/${a.name}`,r);s()},o)}()})}return a.isFile?new Promise((t,i)=>{a.file(i=>{e.push({file:i,path:`${n}/${a.name}`.normalize()}),t(e)},i)}):e}}async function a(e){return new Promise((t,n)=>{let a=URL.createObjectURL(e),i=new Audio;i.src=a,i.load(),i.addEventListener("loadedmetadata",function(e){URL.revokeObjectURL(a),t(Math.ceil(1e3*i.duration))}),i.onerror=function(e){URL.revokeObjectURL(a),n(e)}})}async function i(i){let r=await n(i);!function(e){if(0===e.length)return;let n=e.filter(e=>/\/game.json$/.test(e.path));if(0===n.length)throw new t("ドラッグ＆ドロップされたフォルダに game.json が存在しません。");if(n.length>1)throw new t("ドラッグ＆ドロップされたフォルダに game.json が複数存在します。game.json は1ファイルのみ必要です。");let a=n[0].path.replace(/game.json$/,""),i=RegExp("^"+a);e.forEach(e=>{e.path=e.path.replace(i,"")})}(r);let o={},s={};for(let{file:t,path:n}of r)if(!/\/\.gitkeep$/.test(n)){if(/^(image|assets)\//.test(n)&&("image/png"===t.type||"image/png"===t.type)){let a=await e(t),i={type:"image",path:n,width:a.width,height:a.height,hint:{untainted:!0}};o[i.path]=i}else if(/^(audio|assets)\/.*\.(?:ogg|aac|m4a|mp4)$/.test(n)){let e;let i=n.split(".").pop(),r=n.replace(/\.(ogg|aac|m4a|mp4)$/,"");if(o[r]){if("ogg"!==s[r].ext){e=await a(t);let n=o[r];("ogg"===i||n.duration<e)&&(n.duration=e,s[r]={ext:i,duration:e})}continue}e=await a(t);let l=/\/(?:se|me)\//.test(n),c={type:"audio",path:r,duration:e,systemId:l?"sound":"music",global:!0};o[c.path]=c,s[r]={ext:i,duration:e}}else if(/^text\//.test(n)){let e={type:"text",path:n,global:!0},t=e.path.replace(/^.*\//,"").replace(/\.[^\.]+$/,"");o[t]=e}}let l=JSON.parse(await r.find(e=>"game.json"===e.path).file.text()),c=JSON.parse(await r.find(e=>"text/Plugins.json"===e.path)?.file.text()??"[]"),d=null,m=null;for(let e of c)if(e.status)switch(e.name){case"Community_Basic":d=e.parameters;break;case"AkashicRankingMode":m=e.parameters}return{...l,width:d?Number(d.screenWidth):l.width,height:d?Number(d.screenHeight):l.height,assets:{...l.assets,...o},environment:{...l.environment,nicolive:{...l.environment?.nicolive,preferredSessionParameters:{totalTimeLimit:m?Number(m.totalTimeLimit):75}},external:{send:"0"},"akashic-runtime":{version:"~3.7.3-0",flavor:"-canvas"}}}}window.addEventListener("load",()=>{let e=document.getElementById("drop_zone"),n=document.getElementById("result"),a=document.getElementById("download"),r=document.getElementById("message_area"),o=null;e.addEventListener("drop",async e=>{if(e.preventDefault(),!e.dataTransfer?.items?.length)return;r.innerHTML="";let s=e.dataTransfer.items[0].webkitGetAsEntry();if(s){if(s.isFile){r.innerHTML="game.json を含むフォルダをドラッグ＆ドロップしてください。";return}try{o=await i(s),n.innerHTML=JSON.stringify(o,null,2).replace(/\n/g,"<br>"),a.disabled=!1}catch(e){e instanceof t&&(r.innerHTML=e.message)}}}),e.addEventListener("dragover",e=>e.preventDefault()),a.addEventListener("click",()=>{let e=JSON.stringify(o,null,2),t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.target="_blank",a.download="game.json",a.click(),URL.revokeObjectURL(n)})});